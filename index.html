// ========== VARIÁVEIS GLOBAIS ==========
let currentUser = null;
let users = JSON.parse(localStorage.getItem('users') || '[]');
let investors = JSON.parse(localStorage.getItem('investors') || '[]');
let agents = JSON.parse(localStorage.getItem('agents') || '[]');
let ssaAccounts = JSON.parse(localStorage.getItem('ssaAccounts') || '[]');
let ssaTransactions = JSON.parse(localStorage.getItem('ssaTransactions') || '[]');
let subchannels = JSON.parse(localStorage.getItem('subchannels') || '[]');
let approvals = JSON.parse(localStorage.getItem('approvals') || '[]');
let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
let planoContas = JSON.parse(localStorage.getItem('planoContas') || '[]');
let lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
let auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');

// ========== FUNÇÕES AUXILIARES ==========
function getRoleName(role) {
    const roles = {
        'admin': 'Administrador',
        'manager': 'Gestor',
        'accountant': 'Contabilista',
        'operator': 'Operador',
        'viewer': 'Visualizador'
    };
    return roles[role] || 'Utilizador';
}

function calculateBusinessDays(startDate, endDate) {
    let count = 0;
    const curDate = new Date(startDate.getTime());
    while (curDate <= endDate) {
        const dayOfWeek = curDate.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
        curDate.setDate(curDate.getDate() + 1);
    }
    return count;
}

function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function logAudit(action, details) {
    if (!currentUser) return;
    
    const auditLog = {
        id: Date.now(),
        userId: currentUser.id,
        username: currentUser.username,
        action: action,
        details: details,
        timestamp: new Date().toISOString(),
        ip: '127.0.0.1'
    };
    
    auditLogs.push(auditLog);
    
    if (auditLogs.length > 1000) {
        auditLogs = auditLogs.slice(-1000);
    }
    
    localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
}

// ========== FUNÇÕES DE NAVEGAÇÃO ==========
function switchTab(tabName) {
    // Esconder todas as tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover classe active de todos os botões
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar tab selecionada
    const tabElement = document.getElementById(tabName);
    if (tabElement) {
        tabElement.classList.add('active');
    }
    
    // Ativar botão selecionado
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Atualizar dados específicos da tab
    if (tabName === 'dashboard') {
        updateDashboard();
    } else if (tabName === 'accounting') {
        updateAccountingData();
    } else if (tabName === 'investors') {
        updateInvestorsTable();
    } else if (tabName === 'agents') {
        updateAgentsTable();
        loadAgentsForDropdown();
    } else if (tabName === 'users') {
        updateUsersTable();
        updateAuditLogs();
    } else if (tabName === 'ssa') {
        updateSSAAccountsTable();
        updateSubchannelsTable();
        loadSSAForDropdowns();
    }
}

function switchSubTab(subTabName) {
    // Esconder todos os sub-conteúdos
    document.querySelectorAll('.sub-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover classe active de todos os botões
    document.querySelectorAll('.sub-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar sub-tab selecionada
    document.getElementById(subTabName).classList.add('active');
    
    // Ativar botão selecionado
    event.target.classList.add('active');
}

function switchSSASubTab(subTabName) {
    // Esconder todos os sub-conteúdos SSA
    document.querySelectorAll('#ssa .sub-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover classe active de todos os botões SSA
    document.querySelectorAll('#ssa .sub-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar sub-tab selecionada
    const elementId = 'ssa' + subTabName.charAt(0).toUpperCase() + subTabName.slice(1);
    document.getElementById(elementId).classList.add('active');
    
    // Ativar botão selecionado
    event.target.classList.add('active');
}

// ========== FUNÇÕES DO DASHBOARD ==========
function updateDashboard() {
    updateKPIs();
    updateMyInvestments();
    updateMyCommissions();
}

function updateKPIs() {
    // Calcular total investido
    const totalInvested = investors
        .filter(inv => inv.status === 'Ativo')
        .reduce((sum, inv) => sum + parseFloat(inv.amount), 0);
    document.getElementById('totalInvested').textContent = `MT ${totalInvested.toFixed(2)}`;
    
    // Calcular comissões pendentes (simulado)
    const pendingCommissions = agents
        .filter(agent => agent.status === 'Ativo')
        .length * 500;
    document.getElementById('pendingCommissions').textContent = `MT ${pendingCommissions.toFixed(2)}`;
    
    // Calcular aprovações pendentes
    const pendingApprovals = approvals.filter(app => app.status === 'Pendente').length;
    document.getElementById('pendingApprovals').textContent = pendingApprovals;
}

function updateMyInvestments() {
    const container = document.getElementById('myInvestmentsList');
    
    if (currentUser && (currentUser.role === 'viewer' || currentUser.username === 'investidor')) {
        // Mostrar apenas investimentos do utilizador atual
        const myInvestments = investors.filter(inv => 
            inv.userId === currentUser.id && inv.status === 'Ativo'
        );
        
        if (myInvestments.length > 0) {
            let html = '';
            myInvestments.forEach(inv => {
                const days = calculateBusinessDays(new Date(inv.startDate), new Date());
                const grossYield = inv.amount * (inv.rate / 100) * days;
                const irps = grossYield * (inv.irps / 100);
                const netYield = grossYield - irps;
                
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="font-weight: bold;">${inv.name}</div>
                        <div style="color: #28a745;">MT ${parseFloat(inv.amount).toFixed(2)}</div>
                        <div style="font-size: 12px; color: #6c757d;">
                            Rendimento líquido: MT ${netYield.toFixed(2)} | ${inv.cycle}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">Nenhum investimento ativo</p>';
        }
    } else {
        // Para outros tipos de utilizador, mostrar investimentos recentes
        const recentInvestments = investors
            .filter(inv => inv.status === 'Ativo')
            .slice(0, 5);
        
        if (recentInvestments.length > 0) {
            let html = '';
            recentInvestments.forEach(inv => {
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="font-weight: bold;">${inv.name}</div>
                        <div style="color: #28a745;">MT ${parseFloat(inv.amount).toFixed(2)}</div>
                        <div style="font-size: 12px; color: #6c757d;">${inv.startDate} | ${inv.cycle}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">Nenhum investimento registado</p>';
        }
    }
}

function updateMyCommissions() {
    const container = document.getElementById('myCommissionsList');
    
    if (currentUser && (currentUser.role === 'operator' || currentUser.username === 'agente')) {
        // Mostrar comissões do agente atual
        const agent = agents.find(a => a.userId === currentUser.id);
        
        if (agent) {
            const myCommissions = [
                { id: 1, description: 'Comissão de Vendas', amount: 1250.00, status: 'Pendente', date: '2023-10-15' },
                { id: 2, description: 'Comissão de Investimento', amount: 750.50, status: 'Pago', date: '2023-10-10' }
            ];
            
            let html = '';
            myCommissions.forEach(comm => {
                const statusClass = comm.status === 'Pago' ? 'status-approved' : 'status-pending';
                
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="font-weight: bold;">${comm.description}</div>
                        <div style="color: #28a745;">MT ${comm.amount.toFixed(2)}</div>
                        <div><span class="status ${statusClass}">${comm.status}</span></div>
                        <div style="font-size: 12px; color: #6c757d;">${comm.date}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">Nenhum agente associado</p>';
        }
    } else {
        container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">Apenas disponível para agentes</p>';
    }
}

// ========== FUNÇÕES DE DROPDOWNS ==========
function loadSSAForDropdowns() {
    const dropdowns = [
        'agentSSA', 'ssaDepositFrom', 'ssaDepositTo', 
        'ssaReceiveTo', 'subchannelSSA', 'ssaTransactionAccount',
        'ssaReportAccount'
    ];
    
    dropdowns.forEach(dropdownId => {
        const select = document.getElementById(dropdownId);
        if (select) {
            select.innerHTML = '<option value="">Selecionar SSA</option>';
            
            ssaAccounts
                .filter(acc => acc.status === 'Ativo')
                .forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.code} - ${account.name}`;
                    select.appendChild(option);
            });
        }
    });
}

function loadAgentsForDropdown() {
    const select = document.getElementById('extractAgent');
    if (select) {
        select.innerHTML = '<option value="">Selecionar agente</option>';
        
        agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = `${agent.code} - ${agent.name}`;
            select.appendChild(option);
        });
    }
}

function loadPlanoContasForDropdown() {
    const debitoSelect = document.getElementById('lancamentoDebito');
    const creditoSelect = document.getElementById('lancamentoCredito');
    const contaPaiSelect = document.getElementById('contaPai');
    const filterContaSelect = document.getElementById('filterConta');
    
    // Limpar selects
    [debitoSelect, creditoSelect, contaPaiSelect, filterContaSelect].forEach(select => {
        if (select) {
            select.innerHTML = select.id === 'contaPai' 
                ? '<option value="">Nenhuma (Conta Principal)</option>'
                : '<option value="">Selecionar conta</option>';
        }
    });
    
    // Popular selects
    planoContas.forEach(conta => {
        const optionText = `${conta.codigo} - ${conta.nome}`;
        
        [debitoSelect, creditoSelect, contaPaiSelect, filterContaSelect].forEach(select => {
            if (select) {
                const option = document.createElement('option');
                option.value = conta.id;
                option.textContent = optionText;
                select.appendChild(option);
            }
        });
    });
}

// ========== FUNÇÕES DE AUTENTICAÇÃO ==========
function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    // Garantir que os dados padrão estão inicializados
    initializeDefaultData();
    
    // Recarregar os usuários do localStorage
    users = JSON.parse(localStorage.getItem('users') || '[]');
    
    const user = users.find(u => u.username === username && u.password === password && u.status === 'Ativo');
    
    if (user) {
        currentUser = user;
        
        // Atualizar último acesso
        user.lastAccess = new Date().toISOString();
        localStorage.setItem('users', JSON.stringify(users));
        
        // Registrar log de auditoria
        logAudit('LOGIN', `Utilizador ${user.username} fez login`);
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        // Atualizar informações do utilizador
        document.getElementById('userName').textContent = user.fullName;
        document.getElementById('userRole').textContent = getRoleName(user.role);
        document.getElementById('userAvatar').textContent = user.fullName.charAt(0).toUpperCase();
        
        // Mostrar/ocultar tabs baseado no tipo de utilizador
        if (user.role === 'admin' || user.role === 'manager') {
            document.getElementById('usersTab').style.display = 'block';
            document.getElementById('approvalsTab').style.display = 'block';
        } else {
            document.getElementById('usersTab').style.display = 'none';
            document.getElementById('approvalsTab').style.display = 'none';
        }
        
        // Carregar dados específicos do utilizador
        loadUserSpecificData();
        
        // Mostrar mensagem de boas-vindas
        alert(`Bem-vindo, ${user.fullName}!`);
    } else {
        alert('Credenciais inválidas ou utilizador inativo!');
    }
}

function logout() {
    if (currentUser) {
        logAudit('LOGOUT', `Utilizador ${currentUser.username} fez logout`);
    }
    currentUser = null;
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginForm').reset();
}

function loadUserSpecificData() {
    // Esta função carrega dados específicos do utilizador logado
    if (currentUser && (currentUser.role === 'viewer' || currentUser.username === 'investidor')) {
        // Carregar apenas os investimentos do utilizador
        // Esta lógica já está implementada em updateMyInvestments()
    }
    // Outras personalizações podem ser adicionadas aqui
}

// ========== FUNÇÕES DE INVESTIDORES ==========
function saveInvestor() {
    const id = document.getElementById('investorId').value;
    const name = document.getElementById('investorName').value;
    const docType = document.getElementById('investorDocType').value;
    const docNumber = document.getElementById('investorDocNumber').value;
    const phone = document.getElementById('investorPhone').value;
    const email = document.getElementById('investorEmail').value;
    const account = document.getElementById('investorAccount').value;
    const capitalType = document.getElementById('investorCapitalType').value;
    const amount = parseFloat(document.getElementById('investorAmount').value);
    const rate = parseFloat(document.getElementById('investorRate').value);
    const startDate = document.getElementById('investorStartDate').value;
    const cycle = document.getElementById('investorCycle').value;
    const irps = parseFloat(document.getElementById('investorIRPS').value);
    
    if (id) {
        // Atualizar investidor existente
        const index = investors.findIndex(inv => inv.id == id);
        if (index !== -1) {
            investors[index] = { 
                ...investors[index], 
                name, docType, docNumber, phone, email, account,
                capitalType, amount, rate, startDate, cycle, irps
            };
        }
    } else {
        // Criar novo investidor
        const newInvestor = {
            id: Date.now(),
            name,
            docType,
            docNumber,
            phone,
            email,
            account,
            capitalType,
            amount,
            rate,
            startDate,
            cycle,
            irps,
            status: 'Ativo',
            userId: currentUser.id,
            createdAt: new Date().toISOString()
        };
        
        investors.push(newInvestor);
        
        // Registrar log de auditoria
        logAudit('CREATE_INVESTOR', `Criou investidor: ${name}`);
    }
    
    localStorage.setItem('investors', JSON.stringify(investors));
    updateInvestorsTable();
    clearInvestorForm();
    
    alert(id ? 'Investidor atualizado com sucesso!' : 'Investidor registado com sucesso!');
}

function clearInvestorForm() {
    document.getElementById('investorId').value = '';
    document.getElementById('investorForm').reset();
    document.getElementById('investorRate').value = '0.5';
    document.getElementById('investorIRPS').value = '20.0';
    document.getElementById('investorStartDate').value = new Date().toISOString().split('T')[0];
}

function updateInvestorsTable() {
    const tbody = document.getElementById('investorsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Aplicar filtros
    let filteredInvestors = [...investors];
    const cycleFilter = document.getElementById('filterCycle')?.value;
    const statusFilter = document.getElementById('filterStatus')?.value;
    
    if (cycleFilter) {
        filteredInvestors = filteredInvestors.filter(inv => inv.cycle === cycleFilter);
    }
    
    if (statusFilter) {
        filteredInvestors = filteredInvestors.filter(inv => inv.status === statusFilter);
    }
    
    filteredInvestors.forEach(investor => {
        // Calcular rendimentos
        const days = calculateBusinessDays(new Date(investor.startDate), new Date());
        const grossYield = investor.amount * (investor.rate / 100) * days;
        const irpsAmount = grossYield * (investor.irps / 100);
        const netYield = grossYield - irpsAmount;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${investor.name}</td>
            <td>${investor.docType}: ${investor.docNumber}</td>
            <td>${investor.phone}</td>
            <td>${investor.capitalType === 'proprio' ? 'Próprio' : 'Alheio'}</td>
            <td>MT ${parseFloat(investor.amount).toFixed(2)}</td>
            <td>${investor.startDate}</td>
            <td>${investor.cycle}</td>
            <td>MT ${grossYield.toFixed(2)}</td>
            <td>MT ${irpsAmount.toFixed(2)}</td>
            <td>MT ${netYield.toFixed(2)}</td>
            <td><span class="status status-active">${investor.status}</span></td>
            <td>
                <button class="btn btn-small btn-primary" onclick="editInvestor(${investor.id})">Editar</button>
                <button class="btn btn-small btn-warning" onclick="toggleInvestorStatus(${investor.id})">
                    ${investor.status === 'Ativo' ? 'Desativar' : 'Ativar'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar resumo
    const totalApproved = investors
        .filter(inv => inv.status === 'Ativo')
        .reduce((sum, inv) => sum + parseFloat(inv.amount), 0);
    const summaryElement = document.getElementById('summaryInvested');
    if (summaryElement) {
        summaryElement.textContent = `MT ${totalApproved.toFixed(2)}`;
    }
}

function editInvestor(id) {
    const investor = investors.find(inv => inv.id === id);
    if (investor) {
        document.getElementById('investorId').value = investor.id;
        document.getElementById('investorName').value = investor.name;
        document.getElementById('investorDocType').value = investor.docType;
        document.getElementById('investorDocNumber').value = investor.docNumber;
        document.getElementById('investorPhone').value = investor.phone;
        document.getElementById('investorEmail').value = investor.email || '';
        document.getElementById('investorAccount').value = investor.account || '';
        document.getElementById('investorCapitalType').value = investor.capitalType;
        document.getElementById('investorAmount').value = investor.amount;
        document.getElementById('investorRate').value = investor.rate;
        document.getElementById('investorStartDate').value = investor.startDate;
        document.getElementById('investorCycle').value = investor.cycle;
        document.getElementById('investorIRPS').value = investor.irps;
        
        // Scroll para o formulário
        document.getElementById('investorForm').scrollIntoView();
    }
}

function toggleInvestorStatus(id) {
    const investor = investors.find(inv => inv.id === id);
    if (investor) {
        investor.status = investor.status === 'Ativo' ? 'Inativo' : 'Ativo';
        localStorage.setItem('investors', JSON.stringify(investors));
        updateInvestorsTable();
        
        // Registrar log de auditoria
        logAudit('TOGGLE_INVESTOR_STATUS', `${investor.status === 'Ativo' ? 'Ativou' : 'Desativou'} investidor: ${investor.name}`);
    }
}

function filterInvestors() {
    updateInvestorsTable();
}

function calculateReturn() {
    const capital = parseFloat(document.getElementById('calcCapital').value);
    const days = parseInt(document.getElementById('calcDays').value);
    const type = document.getElementById('calcType').value;
    
    // Taxa diária baseada no tipo de capital
    const dailyRate = type === 'proprio' ? 0.5 : 0.3;
    
    const returnAmount = capital * (dailyRate / 100) * days;
    
    document.getElementById('calcAmount').textContent = `MT ${returnAmount.toFixed(2)}`;
    document.getElementById('calcResult').style.display = 'block';
}

function exportInvestorsExcel() {
    alert('Exportação para Excel será implementada');
}

function exportInvestorsCSV() {
    let csvContent = 'Nome,Documento,Contacto,Capital,Valor,Início,Ciclo,Rendimento Bruto,IRPS,Rendimento Líquido,Situação\n';
    
    investors.forEach(investor => {
        const days = calculateBusinessDays(new Date(investor.startDate), new Date());
        const grossYield = investor.amount * (investor.rate / 100) * days;
        const irpsAmount = grossYield * (investor.irps / 100);
        const netYield = grossYield - irpsAmount;
        
        csvContent += `"${investor.name}","${investor.docType}: ${investor.docNumber}","${investor.phone}","${investor.capitalType === 'proprio' ? 'Próprio' : 'Alheio'}","${investor.amount}","${investor.startDate}","${investor.cycle}","${grossYield.toFixed(2)}","${irpsAmount.toFixed(2)}","${netYield.toFixed(2)}","${investor.status}"\n`;
    });
    
    const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    downloadFile(dataBlob, `investidores_${Date.now()}.csv`);
}

// ========== FUNÇÕES DE AGENTES ==========
function saveAgent() {
    const id = document.getElementById('agentId').value;
    const code = document.getElementById('agentCode').value;
    const name = document.getElementById('agentName').value;
    const location = document.getElementById('agentLocation').value;
    const ssa = document.getElementById('agentSSA').value;
    const phone = document.getElementById('agentPhone').value;
    const email = document.getElementById('agentEmail').value;
    const initialBalance = parseFloat(document.getElementById('agentInitialBalance').value) || 0;
    const status = document.getElementById('agentStatus').value;
    
    if (id) {
        // Atualizar agente existente
        const index = agents.findIndex(agent => agent.id == id);
        if (index !== -1) {
            agents[index] = { 
                ...agents[index], 
                code, name, location, ssa, phone, email, 
                balance: initialBalance, status
            };
        }
    } else {
        // Criar novo agente
        const newAgent = {
            id: Date.now(),
            code,
            name,
            location,
            ssa,
            phone,
            email,
            balance: initialBalance,
            transactions: 0,
            lastMovement: null,
            status,
            userId: currentUser.id,
            createdAt: new Date().toISOString()
        };
        
        agents.push(newAgent);
        
        // Registrar log de auditoria
        logAudit('CREATE_AGENT', `Criou agente: ${name} (${code})`);
    }
    
    localStorage.setItem('agents', JSON.stringify(agents));
    updateAgentsTable();
    clearAgentForm();
    
    alert(id ? 'Agente atualizado com sucesso!' : 'Agente registado com sucesso!');
}

function clearAgentForm() {
    document.getElementById('agentId').value = '';
    document.getElementById('agentForm').reset();
    document.getElementById('agentInitialBalance').value = '0';
}

function updateAgentsTable() {
    const tbody = document.getElementById('agentsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let totalBalance = 0;
    let activeCount = 0;
    let totalTransactions = 0;
    
    agents.forEach(agent => {
        if (agent.status === 'Ativo') {
            totalBalance += agent.balance;
            activeCount++;
            totalTransactions += agent.transactions || 0;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${agent.code}</td>
            <td>${agent.name}</td>
            <td>${agent.location}</td>
            <td>${agent.ssa}</td>
            <td>MT ${agent.balance.toFixed(2)}</td>
            <td>${agent.transactions || 0}</td>
            <td>${agent.lastMovement || 'N/A'}</td>
            <td><span class="status ${agent.status === 'Ativo' ? 'status-active' : 'status-inactive'}">${agent.status}</span></td>
            <td>
                <button class="btn btn-small btn-primary" onclick="editAgent(${agent.id})">Editar</button>
                <button class="btn btn-small btn-warning" onclick="toggleAgentStatus(${agent.id})">
                    ${agent.status === 'Ativo' ? 'Desativar' : 'Ativar'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar resumo
    document.getElementById('totalAgents').textContent = agents.length;
    document.getElementById('activeAgents').textContent = activeCount;
    document.getElementById('totalAgentBalance').textContent = `MT ${totalBalance.toFixed(2)}`;
    document.getElementById('totalTransactions').textContent = totalTransactions;
    
    // Encontrar última movimentação
    const lastMovement = agents.reduce((latest, agent) => {
        if (!agent.lastMovement) return latest;
        const agentDate = new Date(agent.lastMovement);
        const latestDate = latest ? new Date(latest) : new Date(0);
        return agentDate > latestDate ? agent.lastMovement : latest;
    }, null);
    
    document.getElementById('lastMovement').textContent = lastMovement || 'N/A';
    
    // Atualizar dropdown de agentes
    loadAgentsForDropdown();
}

function editAgent(id) {
    const agent = agents.find(agent => agent.id === id);
    if (agent) {
        document.getElementById('agentId').value = agent.id;
        document.getElementById('agentCode').value = agent.code;
        document.getElementById('agentName').value = agent.name;
        document.getElementById('agentLocation').value = agent.location;
        document.getElementById('agentSSA').value = agent.ssa;
        document.getElementById('agentPhone').value = agent.phone || '';
        document.getElementById('agentEmail').value = agent.email || '';
        document.getElementById('agentInitialBalance').value = agent.balance;
        document.getElementById('agentStatus').value = agent.status;
        
        // Scroll para o formulário
        document.getElementById('agentForm').scrollIntoView();
    }
}

function toggleAgentStatus(id) {
    const agent = agents.find(agent => agent.id === id);
    if (agent) {
        agent.status = agent.status === 'Ativo' ? 'Inativo' : 'Ativo';
        localStorage.setItem('agents', JSON.stringify(agents));
        updateAgentsTable();
        
        // Registrar log de auditoria
        logAudit('TOGGLE_AGENT_STATUS', `${agent.status === 'Ativo' ? 'Ativou' : 'Desativou'} agente: ${agent.name} (${agent.code})`);
    }
}

function loadAgentExtract() {
    alert('Funcionalidade de extrato em desenvolvimento');
}

function exportAgentsExcel() {
    alert('Exportação para Excel será implementada');
}

function exportAgentsCSV() {
    let csvContent = 'Código,Nome,Localização,SSA,Saldo,Transações,Última Movimentação,Status\n';
    
    agents.forEach(agent => {
        csvContent += `"${agent.code}","${agent.name}","${agent.location}","${agent.ssa}","${agent.balance}","${agent.transactions || 0}","${agent.lastMovement || 'N/A'}","${agent.status}"\n`;
    });
    
    const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    downloadFile(dataBlob, `agentes_${Date.now()}.csv`);
}

// ========== FUNÇÕES DE UTILIZADORES ==========
function saveUser() {
    const id = document.getElementById('userId').value;
    const fullName = document.getElementById('userFullName').value;
    const username = document.getElementById('userUsername').value;
    const password = document.getElementById('userPassword').value;
    const confirmPassword = document.getElementById('userConfirmPassword').value;
    const role = document.getElementById('userRole').value;
    const status = document.getElementById('userStatus').value;
    
    if (password !== confirmPassword) {
        alert('As senhas não coincidem!');
        return;
    }
    
    // Verificar se username já existe
    const existingUser = users.find(u => u.username === username && u.id != id);
    if (existingUser) {
        alert('Já existe um utilizador com este username!');
        return;
    }
    
    if (id) {
        // Atualizar utilizador existente
        const index = users.findIndex(user => user.id == id);
        if (index !== -1) {
            users[index] = { 
                ...users[index], 
                fullName, username, role, status
            };
            
            // Atualizar senha apenas se foi alterada
            if (password) {
                users[index].password = password;
            }
        }
    } else {
        // Criar novo utilizador
        const newUser = {
            id: Date.now(),
            fullName,
            username,
            password,
            role,
            status,
            createdAt: new Date().toISOString(),
            lastAccess: null
        };
        
        users.push(newUser);
        
        // Registrar log de auditoria
        logAudit('CREATE_USER', `Criou utilizador: ${fullName} (${username})`);
    }
    
    localStorage.setItem('users', JSON.stringify(users));
    updateUsersTable();
    clearUserForm();
    
    alert(id ? 'Utilizador atualizado com sucesso!' : 'Utilizador registado com sucesso!');
}

function clearUserForm() {
    document.getElementById('userId').value = '';
    document.getElementById('userForm').reset();
}

function updateUsersTable() {
    const tbody = document.getElementById('usersTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let totalCount = 0;
    let activeCount = 0;
    let adminCount = 0;
    
    users.forEach(user => {
        totalCount++;
        if (user.status === 'Ativo') activeCount++;
        if (user.role === 'admin') adminCount++;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.fullName}</td>
            <td>${user.username}</td>
            <td><span class="badge badge-${user.role}">${getRoleName(user.role)}</span></td>
            <td><span class="status ${user.status === 'Ativo' ? 'status-active' : 'status-inactive'}">${user.status}</span></td>
            <td>${new Date(user.createdAt).toLocaleDateString()}</td>
            <td>${user.lastAccess ? new Date(user.lastAccess).toLocaleDateString() : 'Nunca'}</td>
            <td>
                <button class="btn btn-small btn-primary" onclick="editUser(${user.id})">Editar</button>
                <button class="btn btn-small btn-warning" onclick="toggleUserStatus(${user.id})">
                    ${user.status === 'Ativo' ? 'Desativar' : 'Ativar'}
                </button>
                ${currentUser && currentUser.id !== user.id ? `
                    <button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">Eliminar</button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar resumo
    document.getElementById('totalUsers').textContent = totalCount;
    document.getElementById('activeUsers').textContent = activeCount;
    document.getElementById('adminUsers').textContent = adminCount;
    
    // Atualizar informações de último acesso
    updateLastAccessInfo();
    
    // Atualizar dropdown de utilizadores para auditoria
    updateAuditUserDropdown();
}

function editUser(id) {
    const user = users.find(user => user.id === id);
    if (user) {
        document.getElementById('userId').value = user.id;
        document.getElementById('userFullName').value = user.fullName;
        document.getElementById('userUsername').value = user.username;
        document.getElementById('userPassword').value = '';
        document.getElementById('userConfirmPassword').value = '';
        document.getElementById('userRole').value = user.role;
        document.getElementById('userStatus').value = user.status;
        
        // Scroll para o formulário
        document.getElementById('userForm').scrollIntoView();
    }
}

function toggleUserStatus(id) {
    const user = users.find(user => user.id === id);
    if (user && currentUser && user.id !== currentUser.id) {
        user.status = user.status === 'Ativo' ? 'Inativo' : 'Ativo';
        localStorage.setItem('users', JSON.stringify(users));
        updateUsersTable();
        
        // Registrar log de auditoria
        logAudit('TOGGLE_USER_STATUS', `${user.status === 'Ativo' ? 'Ativou' : 'Desativou'} utilizador: ${user.fullName}`);
    } else {
        alert('Não pode desativar a sua própria conta!');
    }
}

function deleteUser(id) {
    if (currentUser && id === currentUser.id) {
        alert('Não pode eliminar a sua própria conta!');
        return;
    }
    
    if (confirm('Tem certeza que deseja eliminar este utilizador?')) {
        users = users.filter(user => user.id !== id);
        localStorage.setItem('users', JSON.stringify(users));
        updateUsersTable();
        
        // Registrar log de auditoria
        logAudit('DELETE_USER', `Eliminou utilizador ID: ${id}`);
    }
}

function updateLastAccessInfo() {
    const container = document.getElementById('lastAccessInfo');
    if (!container) return;
    
    const lastAccess = users.reduce((latest, user) => {
        if (!user.lastAccess) return latest;
        const userDate = new Date(user.lastAccess);
        const latestDate = latest ? new Date(latest) : new Date(0);
        return userDate > latestDate ? { user: user.fullName, date: user.lastAccess } : latest;
    }, null);
    
    if (lastAccess) {
        container.innerHTML = `
            <div class="small muted">${lastAccess.user}</div>
            <div class="small">${new Date(lastAccess.date).toLocaleString()}</div>
        `;
    } else {
        container.innerHTML = '<p class="small muted">Nenhum acesso registado</p>';
    }
}

function updateAuditUserDropdown() {
    const select = document.getElementById('auditUser');
    if (!select) return;
    
    select.innerHTML = '<option value="">Todos os utilizadores</option>';
    
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.fullName;
        select.appendChild(option);
    });
}

function updateAuditLogs() {
    const tbody = document.getElementById('auditLogsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Aplicar filtros
    let filteredLogs = [...auditLogs];
    const userFilter = document.getElementById('auditUser')?.value;
    const periodFilter = document.getElementById('auditPeriod')?.value;
    
    if (userFilter) {
        filteredLogs = filteredLogs.filter(log => log.userId == userFilter);
    }
    
    if (periodFilter) {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(periodFilter));
        filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= cutoffDate);
    }
    
    // Ordenar por data (mais recente primeiro)
    filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // Mostrar apenas os últimos 100 registros
    filteredLogs.slice(0, 100).forEach(log => {
        const user = users.find(u => u.id === log.userId);
        const userName = user ? user.fullName : 'Utilizador desconhecido';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td>${userName}</td>
            <td>${log.action}</td>
            <td>${log.details}</td>
            <td>${log.ip}</td>
        `;
        tbody.appendChild(row);
    });
}

function filterAuditLogs() {
    updateAuditLogs();
}

function exportUsersExcel() {
    alert('Exportação para Excel será implementada');
}

function exportUsersCSV() {
    let csvContent = 'Nome,Username,Função,Estado,Data de Criação,Último Acesso\n';
    
    users.forEach(user => {
        csvContent += `"${user.fullName}","${user.username}","${getRoleName(user.role)}","${user.status}","${new Date(user.createdAt).toLocaleDateString()}","${user.lastAccess ? new Date(user.lastAccess).toLocaleDateString() : 'Nunca'}"\n`;
    });
    
    const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    downloadFile(dataBlob, `utilizadores_${Date.now()}.csv`);
}

// ========== FUNÇÕES SSA ==========
function saveSSAAccount() {
    const id = document.getElementById('ssaAccountId').value;
    const code = document.getElementById('ssaAccountCode').value;
    const name = document.getElementById('ssaAccountName').value;
    const balance = parseFloat(document.getElementById('ssaAccountBalance').value) || 0;
    const rate = parseFloat(document.getElementById('ssaAccountRate').value);
    const status = document.getElementById('ssaAccountStatus').value;
    
    // Verificar se código já existe
    const existingAccount = ssaAccounts.find(acc => acc.code === code && acc.id != id);
    if (existingAccount) {
        alert('Já existe uma conta SSA com este código!');
        return;
    }
    
    if (id) {
        // Atualizar conta existente
        const index = ssaAccounts.findIndex(acc => acc.id == id);
        if (index !== -1) {
            ssaAccounts[index] = { 
                ...ssaAccounts[index], 
                code, name, balance, rate, status
            };
        }
    } else {
        // Criar nova conta
        const newAccount = {
            id: Date.now(),
            code,
            name,
            balance,
            rate,
            status,
            createdAt: new Date().toISOString()
        };
        
        ssaAccounts.push(newAccount);
        
        // Registrar log de auditoria
        logAudit('CREATE_SSA_ACCOUNT', `Criou conta SSA: ${name} (${code})`);
    }
    
    localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
    updateSSAAccountsTable();
    loadSSAForDropdowns();
    clearSSAAccountForm();
    
    alert(id ? 'Conta SSA atualizada com sucesso!' : 'Conta SSA registada com sucesso!');
}

function clearSSAAccountForm() {
    document.getElementById('ssaAccountId').value = '';
    document.getElementById('ssaAccountForm').reset();
    document.getElementById('ssaAccountBalance').value = '0';
    document.getElementById('ssaAccountRate').value = '0.5';
}

function updateSSAAccountsTable() {
    const tbody = document.getElementById('ssaAccountsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let totalBalance = 0;
    let activeAccounts = 0;
    
    ssaAccounts.forEach(account => {
        if (account.status === 'Ativo') {
            totalBalance += account.balance;
            activeAccounts++;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${account.code}</td>
            <td>${account.name}</td>
            <td>MT ${account.balance.toFixed(2)}</td>
            <td>${account.rate}%</td>
            <td><span class="status ${account.status === 'Ativo' ? 'status-active' : 'status-inactive'}">${account.status}</span></td>
            <td>
                <button class="btn btn-small btn-primary" onclick="editSSAAccount(${account.id})">Editar</button>
                <button class="btn btn-small btn-warning" onclick="toggleSSAAccountStatus(${account.id})">
                    ${account.status === 'Ativo' ? 'Desativar' : 'Ativar'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar resumo
    document.getElementById('ssaMainBalance').textContent = `MT ${totalBalance.toFixed(2)}`;
    document.getElementById('ssaSubchannels').textContent = subchannels.length;
    document.getElementById('ssaTotalBalance').textContent = `MT ${totalBalance.toFixed(2)}`;
    
    // Calcular transações do dia
    const today = new Date().toISOString().split('T')[0];
    const todayTransactions = ssaTransactions.filter(t => t.date === today).length;
    document.getElementById('ssaTodayTxns').textContent = todayTransactions;
    
    // Calcular transações do mês
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlyTransactions = ssaTransactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
    }).length;
    document.getElementById('ssaMonthlyTxns').textContent = monthlyTransactions;
    
    // Calcular rendimento do mês (simplificado)
    const monthlyYield = totalBalance * (0.5 / 100) * 22;
    document.getElementById('ssaMonthlyYield').textContent = `MT ${monthlyYield.toFixed(2)}`;
}

function editSSAAccount(id) {
    const account = ssaAccounts.find(acc => acc.id === id);
    if (account) {
        document.getElementById('ssaAccountId').value = account.id;
        document.getElementById('ssaAccountCode').value = account.code;
        document.getElementById('ssaAccountName').value = account.name;
        document.getElementById('ssaAccountBalance').value = account.balance;
        document.getElementById('ssaAccountRate').value = account.rate;
        document.getElementById('ssaAccountStatus').value = account.status;
        
        // Scroll para o formulário
        document.getElementById('ssaAccountForm').scrollIntoView();
    }
}

function toggleSSAAccountStatus(id) {
    const account = ssaAccounts.find(acc => acc.id === id);
    if (account) {
        account.status = account.status === 'Ativo' ? 'Inativo' : 'Ativo';
        localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
        updateSSAAccountsTable();
        
        // Registrar log de auditoria
        logAudit('TOGGLE_SSA_ACCOUNT_STATUS', `${account.status === 'Ativo' ? 'Ativou' : 'Desativou'} conta SSA: ${account.name} (${account.code})`);
    }
}

function saveSSADeposit() {
    const fromAccountId = document.getElementById('ssaDepositFrom').value;
    const toAccountId = document.getElementById('ssaDepositTo').value;
    const amount = parseFloat(document.getElementById('ssaDepositAmount').value);
    const date = document.getElementById('ssaDepositDate').value;
    const description = document.getElementById('ssaDepositDescription').value;
    
    if (!fromAccountId || !toAccountId) {
        alert('Selecione as contas de origem e destino!');
        return;
    }
    
    if (fromAccountId === toAccountId) {
        alert('A conta de origem e destino não podem ser iguais!');
        return;
    }
    
    const fromAccount = ssaAccounts.find(acc => acc.id == fromAccountId);
    const toAccount = ssaAccounts.find(acc => acc.id == toAccountId);
    
    if (!fromAccount || !toAccount) {
        alert('Conta não encontrada!');
        return;
    }
    
    if (fromAccount.balance < amount) {
        alert('Saldo insuficiente na conta de origem!');
        return;
    }
    
    // Atualizar saldos
    fromAccount.balance -= amount;
    toAccount.balance += amount;
    
    // Registrar transação
    const transaction = {
        id: Date.now(),
        fromAccountId,
        fromAccountCode: fromAccount.code,
        fromAccountName: fromAccount.name,
        toAccountId,
        toAccountCode: toAccount.code,
        toAccountName: toAccount.name,
        amount,
        type: 'deposit',
        date,
        description,
        yield: amount * (0.5 / 100),
        createdAt: new Date().toISOString()
    };
    
    ssaTransactions.push(transaction);
    
    localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
    localStorage.setItem('ssaTransactions', JSON.stringify(ssaTransactions));
    
    updateSSAAccountsTable();
    updateSSATransactionsTable();
    clearSSADepositForm();
    
    // Registrar log de auditoria
    logAudit('SSA_DEPOSIT', `Depósito de ${fromAccount.code} para ${toAccount.code}: MT ${amount.toFixed(2)}`);
    
    alert('Depósito registado com sucesso!');
}

function saveSSAReceive() {
    const source = document.getElementById('ssaReceiveSource').value;
    const toAccountId = document.getElementById('ssaReceiveTo').value;
    const amount = parseFloat(document.getElementById('ssaReceiveAmount').value);
    const date = document.getElementById('ssaReceiveDate').value;
    const observations = document.getElementById('ssaReceiveObservations').value;
    
    if (!toAccountId) {
        alert('Selecione a conta de destino!');
        return;
    }
    
    const toAccount = ssaAccounts.find(acc => acc.id == toAccountId);
    
    if (!toAccount) {
        alert('Conta não encontrada!');
        return;
    }
    
    // Atualizar saldo
    toAccount.balance += amount;
    
    // Registrar transação
    const transaction = {
        id: Date.now(),
        source,
        toAccountId,
        toAccountCode: toAccount.code,
        toAccountName: toAccount.name,
        amount,
        type: 'receive',
        date,
        observations,
        yield: amount * (0.5 / 100),
        createdAt: new Date().toISOString()
    };
    
    ssaTransactions.push(transaction);
    
    localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
    localStorage.setItem('ssaTransactions', JSON.stringify(ssaTransactions));
    
    updateSSAAccountsTable();
    updateSSATransactionsTable();
    clearSSAReceiveForm();
    
    // Registrar log de auditoria
    logAudit('SSA_RECEIVE', `Recebimento de ${source} para ${toAccount.code}: MT ${amount.toFixed(2)}`);
    
    alert('Recebimento registado com sucesso!');
}

function clearSSADepositForm() {
    document.getElementById('ssaDepositForm').reset();
    document.getElementById('ssaDepositDate').value = new Date().toISOString().split('T')[0];
}

function clearSSAReceiveForm() {
    document.getElementById('ssaReceiveForm').reset();
    document.getElementById('ssaReceiveDate').value = new Date().toISOString().split('T')[0];
}

function updateSSATransactionsTable() {
    const tbody = document.getElementById('ssaTransactionsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Aplicar filtros
    let filteredTransactions = [...ssaTransactions];
    const accountFilter = document.getElementById('ssaTransactionAccount')?.value;
    const typeFilter = document.getElementById('ssaTransactionType')?.value;
    const periodFilter = document.getElementById('ssaTransactionPeriod')?.value;
    
    if (accountFilter) {
        filteredTransactions = filteredTransactions.filter(t => 
            t.fromAccountId == accountFilter || t.toAccountId == accountFilter
        );
    }
    
    if (typeFilter) {
        filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
    }
    
    if (periodFilter && periodFilter !== 'all') {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(periodFilter));
        filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= cutoffDate);
    }
    
    // Ordenar por data (mais recente primeiro)
    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    filteredTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        
        if (transaction.type === 'deposit') {
            row.innerHTML = `
                <td>${transaction.date}</td>
                <td>${transaction.fromAccountCode} - ${transaction.fromAccountName}</td>
                <td>${transaction.toAccountCode} - ${transaction.toAccountName}</td>
                <td>Depósito</td>
                <td>MT ${transaction.amount.toFixed(2)}</td>
                <td>MT ${transaction.yield.toFixed(2)}</td>
                <td>${transaction.description}</td>
                <td>
                    <button class="btn btn-small btn-danger" onclick="deleteSSATransaction(${transaction.id})">Eliminar</button>
                </td>
            `;
        } else {
            row.innerHTML = `
                <td>${transaction.date}</td>
                <td>${transaction.source}</td>
                <td>${transaction.toAccountCode} - ${transaction.toAccountName}</td>
                <td>Recebimento</td>
                <td>MT ${transaction.amount.toFixed(2)}</td>
                <td>MT ${transaction.yield.toFixed(2)}</td>
                <td>${transaction.observations}</td>
                <td>
                    <button class="btn btn-small btn-danger" onclick="deleteSSATransaction(${transaction.id})">Eliminar</button>
                </td>
            `;
        }
        
        tbody.appendChild(row);
    });
}

function deleteSSATransaction(id) {
    if (confirm('Tem certeza que deseja eliminar esta transação?')) {
        const transaction = ssaTransactions.find(t => t.id === id);
        
        if (transaction) {
            // Reverter saldos
            if (transaction.type === 'deposit') {
                const fromAccount = ssaAccounts.find(acc => acc.id == transaction.fromAccountId);
                const toAccount = ssaAccounts.find(acc => acc.id == transaction.toAccountId);
                
                if (fromAccount && toAccount) {
                    fromAccount.balance += transaction.amount;
                    toAccount.balance -= transaction.amount;
                }
            } else {
                const toAccount = ssaAccounts.find(acc => acc.id == transaction.toAccountId);
                if (toAccount) {
                    toAccount.balance -= transaction.amount;
                }
            }
            
            ssaTransactions = ssaTransactions.filter(t => t.id !== id);
            
            localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
            localStorage.setItem('ssaTransactions', JSON.stringify(ssaTransactions));
            
            updateSSAAccountsTable();
            updateSSATransactionsTable();
            
            // Registrar log de auditoria
            logAudit('DELETE_SSA_TRANSACTION', `Eliminou transação SSA ID: ${id}`);
        }
    }
}

function filterSSATransactions() {
    updateSSATransactionsTable();
}

function saveSubchannel() {
    const id = document.getElementById('subchannelId').value;
    const type = document.getElementById('subchannelType').value;
    const code = document.getElementById('subchannelCode').value;
    const name = document.getElementById('subchannelName').value;
    const ssa = document.getElementById('subchannelSSA').value;
    const balance = parseFloat(document.getElementById('subchannelBalance').value) || 0;
    const status = document.getElementById('subchannelStatus').value;
    
    // Verificar se código já existe
    const existingSubchannel = subchannels.find(sc => sc.code === code && sc.id != id);
    if (existingSubchannel) {
        alert('Já existe um subcanal com este código!');
        return;
    }
    
    if (id) {
        // Atualizar subcanal existente
        const index = subchannels.findIndex(sc => sc.id == id);
        if (index !== -1) {
            subchannels[index] = { 
                ...subchannels[index], 
                type, code, name, ssa, balance, status
            };
        }
    } else {
        // Criar novo subcanal
        const newSubchannel = {
            id: Date.now(),
            type,
            code,
            name,
            ssa,
            balance,
            status,
            createdAt: new Date().toISOString()
        };
        
        subchannels.push(newSubchannel);
        
        // Registrar log de auditoria
        logAudit('CREATE_SUBCHANNEL', `Criou subcanal: ${name} (${code}) - ${type}`);
    }
    
    localStorage.setItem('subchannels', JSON.stringify(subchannels));
    updateSubchannelsTable();
    clearSubchannelForm();
    
    alert(id ? 'Subcanal atualizado com sucesso!' : 'Subcanal registado com sucesso!');
}

function clearSubchannelForm() {
    document.getElementById('subchannelId').value = '';
    document.getElementById('subchannelForm').reset();
    document.getElementById('subchannelBalance').value = '0';
}

function updateSubchannelsTable() {
    const tbody = document.getElementById('subchannelsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    let stCount = 0;
    let sagCount = 0;
    let agCount = 0;
    
    subchannels.forEach(subchannel => {
        // Contar por tipo
        if (subchannel.type === 'ST') stCount++;
        else if (subchannel.type === 'SAG') sagCount++;
        else if (subchannel.type === 'AG') agCount++;
        
        const ssaAccount = ssaAccounts.find(acc => acc.id == subchannel.ssa);
        const ssaName = ssaAccount ? ssaAccount.name : 'N/A';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${subchannel.type}</td>
            <td>${subchannel.code}</td>
            <td>${subchannel.name}</td>
            <td>${ssaName}</td>
            <td>MT ${subchannel.balance.toFixed(2)}</td>
            <td><span class="status ${subchannel.status === 'Ativo' ? 'status-active' : 'status-inactive'}">${subchannel.status}</span></td>
            <td>
                <button class="btn btn-small btn-primary" onclick="editSubchannel(${subchannel.id})">Editar</button>
                <button class="btn btn-small btn-warning" onclick="toggleSubchannelStatus(${subchannel.id})">
                    ${subchannel.status === 'Ativo' ? 'Desativar' : 'Ativar'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar resumo
    document.getElementById('totalST').textContent = stCount;
    document.getElementById('totalSAG').textContent = sagCount;
    document.getElementById('totalAG').textContent = agCount;
    
    // Atualizar top subcanais
    updateTopSubchannels();
}

function editSubchannel(id) {
    const subchannel = subchannels.find(sc => sc.id === id);
    if (subchannel) {
        document.getElementById('subchannelId').value = subchannel.id;
        document.getElementById('subchannelType').value = subchannel.type;
        document.getElementById('subchannelCode').value = subchannel.code;
        document.getElementById('subchannelName').value = subchannel.name;
        document.getElementById('subchannelSSA').value = subchannel.ssa;
        document.getElementById('subchannelBalance').value = subchannel.balance;
        document.getElementById('subchannelStatus').value = subchannel.status;
        
        // Scroll para o formulário
        document.getElementById('subchannelForm').scrollIntoView();
    }
}

function toggleSubchannelStatus(id) {
    const subchannel = subchannels.find(sc => sc.id === id);
    if (subchannel) {
        subchannel.status = subchannel.status === 'Ativo' ? 'Inativo' : 'Ativo';
        localStorage.setItem('subchannels', JSON.stringify(subchannels));
        updateSubchannelsTable();
        
        // Registrar log de auditoria
        logAudit('TOGGLE_SUBCHANNEL_STATUS', `${subchannel.status === 'Ativo' ? 'Ativou' : 'Desativou'} subcanal: ${subchannel.name} (${subchannel.code})`);
    }
}

function updateTopSubchannels() {
    const container = document.getElementById('topSubchannels');
    if (!container) return;
    
    // Ordenar subcanais por saldo (maior primeiro)
    const sortedSubchannels = [...subchannels]
        .filter(sc => sc.status === 'Ativo')
        .sort((a, b) => b.balance - a.balance)
        .slice(0, 5);
    
    if (sortedSubchannels.length > 0) {
        let html = '';
        sortedSubchannels.forEach((subchannel, index) => {
            html += `
                <div style="padding: 8px; border-bottom: 1px solid #eee; ${index === 0 ? 'background: var(--light);' : ''}">
                    <div style="font-weight: bold;">${subchannel.code} - ${subchannel.name}</div>
                    <div style="font-size: 12px; color: #28a745;">MT ${subchannel.balance.toFixed(2)}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = '<p class="small muted">Nenhum subcanal ativo</p>';
    }
}

function generateAccountStatement() {
    const accountId = document.getElementById('ssaReportAccount').value;
    
    if (!accountId) {
        alert('Selecione uma conta!');
        return;
    }
    
    const account = ssaAccounts.find(acc => acc.id == accountId);
    const transactions = ssaTransactions.filter(t => 
        t.fromAccountId == accountId || t.toAccountId == accountId
    );
    
    let html = `<h4>Extrato da Conta: ${account.code} - ${account.name}</h4>`;
    html += `<p>Saldo Atual: MT ${account.balance.toFixed(2)}</p>`;
    html += `<table><thead><tr><th>Data</th><th>Descrição</th><th>Débito</th><th>Crédito</th><th>Saldo</th></tr></thead><tbody>`;
    
    let runningBalance = 0;
    
    transactions
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .forEach(transaction => {
            let debit = 0;
            let credit = 0;
            
            if (transaction.fromAccountId == accountId) {
                debit = transaction.amount;
                runningBalance -= transaction.amount;
            } else {
                credit = transaction.amount;
                runningBalance += transaction.amount;
            }
            
            html += `
                <tr>
                    <td>${transaction.date}</td>
                    <td>${transaction.description || transaction.observations || 'Transação'}</td>
                    <td>${debit > 0 ? `MT ${debit.toFixed(2)}` : '-'}</td>
                    <td>${credit > 0 ? `MT ${credit.toFixed(2)}` : '-'}</td>
                    <td>MT ${runningBalance.toFixed(2)}</td>
                </tr>
            `;
        });
    
    html += '</tbody></table>';
    
    document.getElementById('ssaReportResult').innerHTML = html;
}

function generateYieldReport() {
    alert('Relatório de rendimentos em desenvolvimento');
}

function generateConsolidatedReport() {
    alert('Relatório consolidado em desenvolvimento');
}

function exportSSAExcel() {
    alert('Exportação para Excel será implementada');
}

function exportSSACSV() {
    let csvContent = 'Código,Nome,Saldo,Taxa,Status\n';
    
    ssaAccounts.forEach(account => {
        csvContent += `"${account.code}","${account.name}","${account.balance}","${account.rate}","${account.status}"\n`;
    });
    
    const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    downloadFile(dataBlob, `ssa_contas_${Date.now()}.csv`);
}

// ========== FUNÇÕES DE CONTABILIDADE ==========
function saveTransaction() {
    const id = document.getElementById('txnId').value;
    const type = document.getElementById('txnType').value;
    const category = document.getElementById('txnCategory').value;
    const description = document.getElementById('txnDesc').value;
    const value = parseFloat(document.getElementById('txnValue').value);
    const date = document.getElementById('txnDate').value;
    
    if (id) {
        // Atualizar transação existente
        const index = transactions.findIndex(t => t.id == id);
        if (index !== -1) {
            transactions[index] = { ...transactions[index], type, category, description, value, date };
        }
    } else {
        // Criar nova transação
        const newTransaction = {
            id: Date.now(),
            type,
            category,
            description,
            value,
            date,
            userId: currentUser.id,
            createdAt: new Date().toISOString()
        };
        
        transactions.push(newTransaction);
    }
    
    localStorage.setItem('transactions', JSON.stringify(transactions));
    updateTransactionsTable();
    updateAccountingKPIs();
    document.getElementById('txnForm').reset();
    document.getElementById('txnId').value = '';
    document.getElementById('txnDate').value = new Date().toISOString().split('T')[0];
    
    alert(id ? 'Transação atualizada com sucesso!' : 'Transação registada com sucesso!');
}

function updateTransactionsTable() {
    const tbody = document.getElementById('txnsTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Ordenar transações por data (mais recente primeiro)
    const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedTransactions.forEach(transaction => {
        const typeText = transaction.type === 'income' ? 'Receita' : 'Despesa';
        const typeClass = transaction.type === 'income' ? 'status-approved' : 'status-rejected';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${transaction.date}</td>
            <td><span class="status ${typeClass}">${typeText}</span></td>
            <td>${transaction.category}</td>
            <td>${transaction.description}</td>
            <td>MT ${transaction.value.toFixed(2)}</td>
            <td>
                <button class="btn btn-small btn-primary" onclick="editTransaction(${transaction.id})">Editar</button>
                <button class="btn btn-small btn-danger" onclick="deleteTransaction(${transaction.id})">Eliminar</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function editTransaction(id) {
    const transaction = transactions.find(t => t.id === id);
    if (transaction) {
        document.getElementById('txnId').value = transaction.id;
        document.getElementById('txnType').value = transaction.type;
        document.getElementById('txnCategory').value = transaction.category;
        document.getElementById('txnDesc').value = transaction.description;
        document.getElementById('txnValue').value = transaction.value;
        document.getElementById('txnDate').value = transaction.date;
        
        // Scroll para o formulário
        document.getElementById('txnForm').scrollIntoView();
    }
}

function deleteTransaction(id) {
    if (confirm('Tem certeza que deseja eliminar esta transação?')) {
        transactions = transactions.filter(t => t.id !== id);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        updateTransactionsTable();
        updateAccountingKPIs();
    }
}

function updateAccountingKPIs() {
    const income = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.value, 0);
        
    const expense = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.value, 0);
        
    const balance = income - expense;
    
    document.getElementById('kpiIncome').textContent = `MT ${income.toFixed(2)}`;
    document.getElementById('kpiExpense').textContent = `MT ${expense.toFixed(2)}`;
    document.getElementById('kpiBalance').textContent = `MT ${balance.toFixed(2)}`;
}

function updateAccountingData() {
    updateTransactionsTable();
    updateAccountingKPIs();
    updatePlanoContasTree();
    updateLancamentosTable();
}

// ========== FUNÇÕES DO PLANO DE CONTAS ==========
function updatePlanoContasTree() {
    const container = document.getElementById('planoContasTree');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Agrupar contas por tipo
    const contasPorTipo = {};
    planoContas.forEach(conta => {
        if (!contasPorTipo[conta.tipo]) {
            contasPorTipo[conta.tipo] = [];
        }
        contasPorTipo[conta.tipo].push(conta);
    });
    
    // Renderizar por tipo
    Object.keys(contasPorTipo).forEach(tipo => {
        const tipoDiv = document.createElement('div');
        tipoDiv.className = 'account-class';
        tipoDiv.textContent = tipo;
        container.appendChild(tipoDiv);
        
        // Encontrar contas principais (sem pai)
        const contasPrincipais = contasPorTipo[tipo].filter(conta => !conta.pai);
        
        contasPrincipais.forEach(conta => {
            renderConta(container, conta, 0);
        });
    });
}

function renderConta(container, conta, nivel) {
    const contaDiv = document.createElement('div');
    contaDiv.className = 'account-item';
    contaDiv.style.marginLeft = `${nivel * 20}px`;
    
    contaDiv.innerHTML = `
        <div>
            <span class="account-code">${conta.codigo}</span> - ${conta.nome}
            <span style="float: right;">
                <button class="btn btn-small btn-primary" onclick="editConta(${conta.id})">Editar</button>
                <button class="btn btn-small btn-danger" onclick="deleteConta(${conta.id})">Eliminar</button>
            </span>
        </div>
        ${conta.descricao ? `<div class="small">${conta.descricao}</div>` : ''}
    `;
    
    container.appendChild(contaDiv);
    
    // Encontrar e renderizar contas filhas
    const contasFilhas = planoContas.filter(c => c.pai === conta.id);
    contasFilhas.forEach(filha => {
        renderConta(container, filha, nivel + 1);
    });
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function saveConta() {
    const id = document.getElementById('contaId').value;
    const codigo = document.getElementById('contaCodigo').value;
    const nome = document.getElementById('contaNome').value;
    const tipo = document.getElementById('contaTipo').value;
    const pai = document.getElementById('contaPai').value || null;
    const descricao = document.getElementById('contaDescricao').value;
    
    // Validar código único
    const codigoExistente = planoContas.find(c => c.codigo === codigo && c.id != id);
    if (codigoExistente) {
        alert('Já existe uma conta com este código!');
        return;
    }
    
    if (id) {
        // Atualizar conta existente
        const index = planoContas.findIndex(c => c.id == id);
        if (index !== -1) {
            planoContas[index] = { ...planoContas[index], codigo, nome, tipo, pai: pai ? parseInt(pai) : null, descricao };
        }
    } else {
        // Criar nova conta
        const newConta = {
            id: Date.now(),
            codigo,
            nome,
            tipo,
            pai: pai ? parseInt(pai) : null,
            descricao
        };
        
        planoContas.push(newConta);
    }
    
    localStorage.setItem('planoContas', JSON.stringify(planoContas));
    updatePlanoContasTree();
    loadPlanoContasForDropdown();
    closeModal('novaConta');
    document.getElementById('contaForm').reset();
    document.getElementById('contaId').value = '';
    
    alert(id ? 'Conta atualizada com sucesso!' : 'Conta criada com sucesso!');
}

function editConta(id) {
    const conta = planoContas.find(c => c.id === id);
    if (conta) {
        document.getElementById('contaId').value = conta.id;
        document.getElementById('contaCodigo').value = conta.codigo;
        document.getElementById('contaNome').value = conta.nome;
        document.getElementById('contaTipo').value = conta.tipo;
        document.getElementById('contaPai').value = conta.pai || '';
        document.getElementById('contaDescricao').value = conta.descricao || '';
        
        showModal('novaConta');
    }
}

function deleteConta(id) {
    // Verificar se a conta tem contas filhas
    const contasFilhas = planoContas.filter(c => c.pai === id);
    if (contasFilhas.length > 0) {
        alert('Não é possível eliminar uma conta que tem contas filhas!');
        return;
    }
    
    if (confirm('Tem certeza que deseja eliminar esta conta?')) {
        planoContas = planoContas.filter(c => c.id !== id);
        localStorage.setItem('planoContas', JSON.stringify(planoContas));
        updatePlanoContasTree();
        loadPlanoContasForDropdown();
    }
}

function exportPlanoContas() {
    const dataStr = JSON.stringify(planoContas, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    downloadFile(dataBlob, `plano_contas_${Date.now()}.json`);
}

function importPlanoContas() {
    const fileInput = document.getElementById('importPlanoFile');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                planoContas = importedData;
                localStorage.setItem('planoContas', JSON.stringify(planoContas));
                updatePlanoContasTree();
                loadPlanoContasForDropdown();
                alert('Plano de contas importado com sucesso!');
            } catch (error) {
                alert('Erro ao importar ficheiro: ' + error.message);
            }
        };
        reader.readAsText(file);
    }
}

// ========== FUNÇÕES DE RELATÓRIOS ==========
function generateBalanceSheet() {
    const reportResult = document.getElementById('reportResult');
    if (!reportResult) return;
    
    reportResult.innerHTML = '<h4>Balanço Patrimonial</h4><p>Relatório gerado com sucesso. Esta funcionalidade está em desenvolvimento.</p>';
}

function generateIncomeStatement() {
    const reportResult = document.getElementById('reportResult');
    if (!reportResult) return;
    
    reportResult.innerHTML = '<h4>Demonstração de Resultados</h4><p>Relatório gerado com sucesso. Esta funcionalidade está em desenvolvimento.</p>';
}

function generateCashFlow() {
    const reportResult = document.getElementById('reportResult');
    if (!reportResult) return;
    
    reportResult.innerHTML = '<h4>Fluxo de Caixa</h4><p>Relatório gerado com sucesso. Esta funcionalidade está em desenvolvimento.</p>';
}

// ========== FUNÇÕES DE LANÇAMENTOS ==========
function saveLancamento() {
    const data = document.getElementById('lancamentoData').value;
    const descricao = document.getElementById('lancamentoDescricao').value;
    const debito = document.getElementById('lancamentoDebito').value;
    const credito = document.getElementById('lancamentoCredito').value;
    const valor = parseFloat(document.getElementById('lancamentoValor').value);
    
    if (debito === credito) {
        alert('As contas de débito e crédito não podem ser iguais!');
        return;
    }
    
    const novoLancamento = {
        id: Date.now(),
        data,
        descricao,
        debito: parseInt(debito),
        credito: parseInt(credito),
        valor,
        userId: currentUser.id,
        createdAt: new Date().toISOString()
    };
    
    lancamentos.push(novoLancamento);
    localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
    
    updateLancamentosTable();
    document.getElementById('lancamentoForm').reset();
    document.getElementById('lancamentoData').value = new Date().toISOString().split('T')[0];
    
    alert('Lançamento registado com sucesso!');
}

function updateLancamentosTable() {
    const tbody = document.getElementById('lancamentosTable').querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Aplicar filtros
    let filteredLancamentos = [...lancamentos];
    
    const dataInicio = document.getElementById('filterDataInicio')?.value;
    const dataFim = document.getElementById('filterDataFim')?.value;
    const contaFiltro = document.getElementById('filterConta')?.value;
    
    if (dataInicio) {
        filteredLancamentos = filteredLancamentos.filter(l => l.data >= dataInicio);
    }
    
    if (dataFim) {
        filteredLancamentos = filteredLancamentos.filter(l => l.data <= dataFim);
    }
    
    if (contaFiltro) {
        const contaId = parseInt(contaFiltro);
        filteredLancamentos = filteredLancamentos.filter(l => 
            l.debito === contaId || l.credito === contaId
        );
    }
    
    // Ordenar por data (mais recente primeiro)
    filteredLancamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    filteredLancamentos.forEach(lancamento => {
        const contaDebito = planoContas.find(c => c.id === lancamento.debito);
        const contaCredito = planoContas.find(c => c.id === lancamento.credito);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${lancamento.data}</td>
            <td>${lancamento.descricao}</td>
            <td>${contaDebito ? `${contaDebito.codigo} - ${contaDebito.nome}` : 'N/A'}</td>
            <td>${contaCredito ? `${contaCredito.codigo} - ${contaCredito.nome}` : 'N/A'}</td>
            <td>MT ${lancamento.valor.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

function filtrarLancamentos() {
    updateLancamentosTable();
}

// ========== FUNÇÕES DE BACKUP ==========
function exportBackup() {
    const backupData = {
        users,
        investors,
        agents,
        ssaAccounts,
        ssaTransactions,
        subchannels,
        approvals,
        transactions,
        planoContas,
        lancamentos,
        auditLogs,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    downloadFile(dataBlob, `great_mola_backup_${Date.now()}.json`);
}

function importBackup() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    
    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Atualizar todos os dados
                    if (backupData.users) users = backupData.users;
                    if (backupData.investors) investors = backupData.investors;
                    if (backupData.agents) agents = backupData.agents;
                    if (backupData.ssaAccounts) ssaAccounts = backupData.ssaAccounts;
                    if (backupData.ssaTransactions) ssaTransactions = backupData.ssaTransactions;
                    if (backupData.subchannels) subchannels = backupData.subchannels;
                    if (backupData.approvals) approvals = backupData.approvals;
                    if (backupData.transactions) transactions = backupData.transactions;
                    if (backupData.planoContas) planoContas = backupData.planoContas;
                    if (backupData.lancamentos) lancamentos = backupData.lancamentos;
                    if (backupData.auditLogs) auditLogs = backupData.auditLogs;
                    
                    // Salvar no localStorage
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('investors', JSON.stringify(investors));
                    localStorage.setItem('agents', JSON.stringify(agents));
                    localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
                    localStorage.setItem('ssaTransactions', JSON.stringify(ssaTransactions));
                    localStorage.setItem('subchannels', JSON.stringify(subchannels));
                    localStorage.setItem('approvals', JSON.stringify(approvals));
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    localStorage.setItem('planoContas', JSON.stringify(planoContas));
                    localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
                    localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
                    
                    // Recarregar a interface
                    loadInitialData();
                    alert('Backup restaurado com sucesso!');
                } catch (error) {
                    alert('Erro ao restaurar backup: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
    };
    
    fileInput.click();
}

// ========== INICIALIZAÇÃO ==========
function initializeDefaultData() {
    // Criar utilizadores padrão se não existirem
    if (users.length === 0) {
        users = [
            {
                id: 1,
                fullName: 'Administrador do Sistema',
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                status: 'Ativo',
                createdAt: new Date().toISOString(),
                lastAccess: null
            },
            {
                id: 2,
                fullName: 'Gestor Financeiro',
                username: 'gestor',
                password: 'gestor123',
                role: 'manager',
                status: 'Ativo',
                createdAt: new Date().toISOString(),
                lastAccess: null
            },
            {
                id: 3,
                fullName: 'Analista Contabil',
                username: 'analista',
                password: 'analista123',
                role: 'accountant',
                status: 'Ativo',
                createdAt: new Date().toISOString(),
                lastAccess: null
            },
            {
                id: 4,
                fullName: 'Agente Comercial',
                username: 'agente',
                password: 'agente123',
                role: 'operator',
                status: 'Ativo',
                createdAt: new Date().toISOString(),
                lastAccess: null
            },
            {
                id: 5,
                fullName: 'Investidor Exemplo',
                username: 'investidor',
                password: 'invest123',
                role: 'viewer',
                status: 'Ativo',
                createdAt: new Date().toISOString(),
                lastAccess: null
            }
        ];
        localStorage.setItem('users', JSON.stringify(users));
    }
    
    // Criar SSA principal se não existir
    if (ssaAccounts.length === 0) {
        ssaAccounts = [
            {
                id: 1,
                code: 'SOFSSA00035',
                name: 'VICTOR ALFREDO JORGE UCAMA',
                balance: 10000,
                rate: 0.5,
                status: 'Ativo',
                createdAt: new Date().toISOString()
            }
        ];
        localStorage.setItem('ssaAccounts', JSON.stringify(ssaAccounts));
    }
    
    // Inicializar plano de contas se não existir
    if (planoContas.length === 0) {
        planoContas = [
            { id: 1, codigo: '1', nome: 'Ativo', tipo: 'Ativo', pai: null, descricao: 'Contas do Ativo' },
            { id: 2, codigo: '1.1', nome: 'Ativo Circulante', tipo: 'Ativo', pai: 1, descricao: 'Ativos de curto prazo' },
            { id: 3, codigo: '1.1.1', nome: 'Caixa e Equivalentes', tipo: 'Ativo', pai: 2, descricao: 'Dinheiro em caixa e bancos' },
            { id: 4, codigo: '1.1.2', nome: 'Contas a Receber', tipo: 'Ativo', pai: 2, descricao: 'Valores a receber de clientes' },
            { id: 5, codigo: '2', nome: 'Passivo', tipo: 'Passivo', pai: null, descricao: 'Contas do Passivo' },
            { id: 6, codigo: '2.1', nome: 'Passivo Circulante', tipo: 'Passivo', pai: 5, descricao: 'Passivos de curto prazo' },
            { id: 7, codigo: '2.1.1', nome: 'Fornecedores', tipo: 'Passivo', pai: 6, descricao: 'Contas a pagar a fornecedores' },
            { id: 8, codigo: '3', nome: 'Patrimônio Líquido', tipo: 'Patrimonio', pai: null, descricao: 'Contas do Patrimônio Líquido' },
            { id: 9, codigo: '3.1', nome: 'Capital Social', tipo: 'Patrimonio', pai: 8, descricao: 'Capital integralizado' },
            { id: 10, codigo: '4', nome: 'Receitas', tipo: 'Receita', pai: null, descricao: 'Contas de Receita' },
            { id: 11, codigo: '4.1', nome: 'Receitas Operacionais', tipo: 'Receita', pai: 10, descricao: 'Receitas da atividade principal' },
            { id: 12, codigo: '5', nome: 'Despesas', tipo: 'Despesa', pai: null, descricao: 'Contas de Despesa' },
            { id: 13, codigo: '5.1', nome: 'Despesas Operacionais', tipo: 'Despesa', pai: 12, descricao: 'Despesas da atividade principal' }
        ];
        localStorage.setItem('planoContas', JSON.stringify(planoContas));
    }
}

function setupForms() {
    // Configurar formulário de login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        login();
    });
    
    // Configurar formulário de investidor
    document.getElementById('investorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveInvestor();
    });
    
    // Configurar formulário de agente
    document.getElementById('agentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveAgent();
    });
    
    // Configurar formulário de utilizador
    document.getElementById('userForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveUser();
    });
    
    // Configurar formulário de SSA
    document.getElementById('ssaAccountForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSSAAccount();
    });
    
    // Configurar formulário de transação SSA
    document.getElementById('ssaDepositForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSSADeposit();
    });
    
    document.getElementById('ssaReceiveForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSSAReceive();
    });
    
    // Configurar formulário de subcanal
    document.getElementById('subchannelForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSubchannel();
    });
    
    // Configurar formulário de transação
    document.getElementById('txnForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveTransaction();
    });
    
    // Configurar formulário de conta contábil
    document.getElementById('contaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveConta();
    });
    
    // Configurar formulário de lançamento
    document.getElementById('lancamentoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveLancamento();
    });
}

function setupDefaultDates() {
    const today = new Date().toISOString().split('T')[0];
    const dateFields = [
        'investorStartDate', 'ssaDepositDate', 'ssaReceiveDate', 
        'txnDate', 'lancamentoData'
    ];
    
    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = today;
        }
    });
}

function loadInitialData() {
    // Carregar dados para dropdowns
    loadSSAForDropdowns();
    loadPlanoContasForDropdown();
    
    // Atualizar tabelas
    updateInvestorsTable();
    updateAgentsTable();
    updateUsersTable();
    updateSSAAccountsTable();
    updateSubchannelsTable();
    updateTransactionsTable();
    updatePlanoContasTree();
    updateLancamentosTable();
    
    // Atualizar KPIs
    updateKPIs();
}

// ========== INICIALIZAÇÃO DO SISTEMA ==========
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar dados padrão se não existirem
    initializeDefaultData();
    
    // Configurar formulários
    setupForms();
    
    // Configurar datas padrão
    setupDefaultDates();
    
    // Carregar dados iniciais
    loadInitialData();
});
