<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Great Mola - Sistema Completo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíº</text></svg>" type="image/svg+xml">
    <style>
        /* ... (todo o CSS permanece igual) ... */
    </style>
</head>
<body>
    <!-- ... (todo o HTML permanece igual) ... -->

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        let investors = JSON.parse(localStorage.getItem('investors') || '[]');
        let agents = JSON.parse(localStorage.getItem('agents') || '[]');
        let ssaAccounts = JSON.parse(localStorage.getItem('ssaAccounts') || '[]');
        let ssaTransactions = JSON.parse(localStorage.getItem('ssaTransactions') || '[]');
        let subchannels = JSON.parse(localStorage.getItem('subchannels') || '[]');
        let approvals = JSON.parse(localStorage.getItem('approvals') || '[]');
        let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        let planoContas = JSON.parse(localStorage.getItem('planoContas') || '[]');
        let lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
        let auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
        
        // ========== DADOS DO PLANO DE CONTAS (DO SEU CSV) ==========
        const planoContasCSV = `Codigo,Nome,Tipo,Descricao,class
1,1.1.1,Caixa Sede,Ativo,1
2,1.1.2,Caixa Agentes,Ativo,1
3,1.1.3,Conta Bancaria Principal,Ativo,1
4,1.1.4,Conta Bancaria Secundaria,Ativo,1
5,1.1.5,Conta eMola (Float Geral),Ativo,1
6,1.1.6,Conta eMola Agente Principal,Ativo,1
7,1.1.7,Conta Paytek / Parceiro Digital,Ativo,1
8,1.1.8,Depositos em transito,Ativo,1
9,1.1.2,Transferencias a Confirmar,Ativo,1
10,1.1.2,Saques Pendurados,Ativo,1
11,1.1.2,Depositos em Processamento,Ativo,1
12,1.1.2,Fundos para Reconcilia√ß√£o,Ativo,1
13,2.2.1,Float em Circulacao,Ativo,2
14,2.2.1,Float por Agente,Ativo,2
15,2.2.1,Float em Reposicao,Ativo,2
16,2.2.1,Fundos Retidos Temporariamente,Ativo,2
17,2.2.2,Fundos em Recolha (cash-out),Ativo,2
18,2.2.2,Fundos em Caixa Maleavel,Ativo,2
19,2.2.2,Fundos em Rota de Transporte,Ativo,2
20,2.2.2,Fundos Delivery em Trsinsito,Ativo,2
21,2.2.2,Fundos Retidos de Seguros,Ativo,2
22,2.2.3,Saldo em Carteiras Digitais (Clientes),Ativo,2
23,2.2.3,Saldo em Contas de Investidores,Ativo,2
24,2.2.3,Creditos Promocionais / Bonus,Ativo,2
25,3.3.1,Capital Aplicado Internamente,Ativo,3
26,3.3.1,Aplicacoes de Curto Prazo,Ativo,3
27,3.3.1,Aplicacoes de Longo Prazo,Ativo,3
28,3.3.1,Investimentos em Startups / Parcerias,Ativo,3
29,3.3.1,Investimento em Frota (Motociclos),Ativo,3
30,3.3.1,Investimento em Expansao Digital (App/ERP),Ativo,3
31,3.3.2,Capital de Investidores Ativos,Passivo,3
32,3.3.2,Rendimentos a Pagar (Investidores),Passivo,3
33,3.3.2,Fundos Captados em Operacoes Especiais,Passivo,3
34,3.3.3,Juros de Aplicacoes Proprias,Receita,3
35,3.3.3,Juros de Capital Alheio,Receita,3
36,3.3.3,Rendimento em Processamento,Receita,3
37,3.3.4,Depositos a Prazo,Ativo,3
38,3.3.4,Titulos e Obrigacoes,Ativo,3
39,3.3.4,Garantias de Contrato,Ativo,3
40,4.4.1,Clientes eMola (Carteiras Ativas),Ativo,4
41,4.4.1,Clientes a Receber (Servicos),Ativo,4
42,4.4.1,Clientes em Atraso,Ativo,4
43,4.4.1,Clientes Corporativos,Ativo,4
44,4.4.2,Investidores Ativos,Passivo,4
45,4.4.2,Investidores a Liquidar,Passivo,4
46,4.4.2,Investidores Suspensos,Passivo,4
47,4.4.2,Juros a Pagar,Passivo,4
48,4.4.3,Agentes Autorizados,Passivo,4
49,4.4.3,Sub-Agentes,Passivo,4
50,4.4.3,Comisscoes a Liquidar,Passivo,4
51,4.4.3,Incentivos Pendentes,Passivo,4
52,4.4.4,Adiantamentos a Fornecedores,Ativo,4
53,4.4.4,Funcionarios (Adiantamentos),Ativo,4
54,4.4.4,Contas de Reconciliacao,Ativo,4
55,4.4.4,Fornecedores de Delivery,Passivo,4
56,4.4.4,Colaboradores de Campo,Passivo,4
57,4.4.4,Clientes Delivery a Receber,Ativo,4
58,5.5.1,Capital Subscrito,Patrimonio,5
59,5.5.1,Capital Realizado,Patrimonio,5
60,5.5.2,Reserva Legal,Patrimonio,5
61,5.5.2,Reserva de Expansao,Patrimonio,5
62,5.5.2,Reserva de Contingencia,Patrimonio,5
63,5.5.3,Resultados Anteriores,Patrimonio,5
64,5.5.3,Lucros / Prejuizos Acumulados,Patrimonio,5
65,5.5.4,Resultado Liquido Atual,Patrimonio,5
66,5.5.4,Resultado Provisorio,Patrimonio,5
67,6.6.1,Despesas de Operacao eMola,Despesa,6
68,6.6.1,Taxas de Transacao,Despesa,6
69,6.6.1,Comissoes de Parceiros,Despesa,6
70,6.6.1,Despesas de Plataforma,Despesa,6
71,6.6.2,Salarios e Vencimentos,Despesa,6
72,6.6.2,Beneficios e Subsidios,Despesa,6
73,6.6.2,Contribuicoes INSS,Despesa,6
74,6.6.2,Formacao e Capacitacao,Despesa,6
75,6.6.3,Juros Pagos a Investidores,Despesa,6
76,6.6.3,Descontos Financeiros,Despesa,6
77,6.6.3,Custos Bancarios,Despesa,6
78,6.6.4,Material de Escritorio,Despesa,6
79,6.6.4,Servicos de Limpeza e Manutencao,Despesa,6
80,6.6.4,Telecomunicacao,Despesa,6
81,6.6.4,Transporte e Logistica,Despesa,6
82,6.6.4,Combustivel e Lubrificantes,Despesa,6
83,6.6.4,Pecas e Reparacoes de Motas,Despesa,6
84,6.6.4,Uniformes e Equipamento de Entrega,Despesa,6
85,6.6.4,Despesas de Seguro (motorizadas e colaboradores),Despesa,6
86,6.6.4,Taxas e Licencas de Circulacao,Despesa,6
87,6.6.5,IRPS Retido,Despesa,6
88,6.6.5,IVA,Despesa,6
89,6.6.5,Outras Taxas Fiscais,Despesa,6
90,6.6.5,Despesas de Seguranca e Vigilancia,Despesa,6
91,6.6.5,Comissoes Pagas a Sub-Agentes,Despesa,6
92,6.6.5,Despesas de Marketing Delivery & Digital,Despesa,6
93,7.7.1,Comissoes Recebidas (Transacoes),Receita,7
94,7.7.1,Taxas de Servico,Receita,7
95,7.7.1,Receitas de Sub-Agentes,Receita,7
96,7.7.2,Juros de Aplicacao,Receita,7
97,7.7.2,Rendimentos sobre Capital,Receita,7
98,7.7.2,Descontos Obtidos,Receita,7
99,7.7.3,Receitas de Parcerias,Receita,7
100,7.7.3,Receitas de Consultoria Financeira,Receita,7
101,7.7.3,Ganhos Extraordinarios,Receita,7
102,7.7.3,Receitas de Delivery (Entregas),Receita,7
103,7.7.3,Servicos Expresso / Entrega Rapida,Receita,7
104,7.7.3,Receitas de Recolha de Valores (Cash-in/Cash-out),Receita,7
105,7.7.3,Parcerias de Logistica e Transporte,Receita,7
106,7.7.3,"Receitas de Plataforma Digital (app, API, ERP)",Receita,7
107,7.7.3,Receitas de Formacao / Consultoria Delivery,Receita,7
108,8.8.1,Resultado Bruto,Patrimonio,8
109,8.8.1,Resultado Operacional Liquido,Patrimonio,8
110,8.8.2,Ganhos Financeiros,Receita,8
111,8.8.2,Custos Financeiros,Despesa,8
112,8.8.3,Resultado Antes de Impostos,Patrimonio,8
113,8.8.4,Resultado Liquido do Exercicio,Patrimonio,8
114,9.9.1,Caucoes Depositadas,Compensacao,9
115,9.9.1,Caucoes Recebidas,Compensacao,9
116,9.9.2,Contratos de Agentes,Compensacao,9
117,9.9.2,Contratos de Investidores,Compensacao,9
118,9.9.2,Acordos Comerciais,Compensacao,9
119,9.9.3,Fundos de Terceiros em Gestao,Compensacao,9
120,9.9.3,Operacoes Conjuntas,Compensacao,9
121,9.9.4,Notas de Auditoria,Compensacao,9
122,9.9.4,Notas de Ajuste,Compensacao,9`;

        // ========== INICIALIZA√á√ÉO DE DADOS PADR√ÉO ==========
        function initializeDefaultData() {
            // Verificar se j√° existem dados
            if (users.length === 0) {
                console.log('Inicializando dados padr√£o...');
                
                // Criar utilizadores padr√£o
                const defaultUsers = [
                    {
                        id: 1,
                        fullName: 'Administrador',
                        username: 'admin',
                        password: 'admin123',
                        role: 'admin',
                        status: 'Ativo',
                        createdAt: new Date().toISOString(),
                        lastAccess: null
                    },
                    {
                        id: 2,
                        fullName: 'Gestor Financeiro',
                        username: 'gestor',
                        password: 'gestor123',
                        role: 'manager',
                        status: 'Ativo',
                        createdAt: new Date().toISOString(),
                        lastAccess: null
                    },
                    {
                        id: 3,
                        fullName: 'Analista Contabil√≠stico',
                        username: 'analista',
                        password: 'analista123',
                        role: 'accountant',
                        status: 'Ativo',
                        createdAt: new Date().toISOString(),
                        lastAccess: null
                    },
                    {
                        id: 4,
                        fullName: 'Agente Comercial',
                        username: 'agente',
                        password: 'agente123',
                        role: 'operator',
                        status: 'Ativo',
                        createdAt: new Date().toISOString(),
                        lastAccess: null
                    },
                    {
                        id: 5,
                        fullName: 'Investidor',
                        username: 'investidor',
                        password: 'invest123',
                        role: 'viewer',
                        status: 'Ativo',
                        createdAt: new Date().toISOString(),
                        lastAccess: null
                    }
                ];

                users = defaultUsers;
                localStorage.setItem('users', JSON.stringify(users));
                
                // Inicializar plano de contas se estiver vazio
                if (planoContas.length === 0) {
                    importPlanoContasFromCSV();
                }
                
                // Inicializar outras estruturas de dados vazias
                localStorage.setItem('investors', JSON.stringify([]));
                localStorage.setItem('agents', JSON.stringify([]));
                localStorage.setItem('ssaAccounts', JSON.stringify([]));
                localStorage.setItem('ssaTransactions', JSON.stringify([]));
                localStorage.setItem('subchannels', JSON.stringify([]));
                localStorage.setItem('approvals', JSON.stringify([]));
                localStorage.setItem('transactions', JSON.stringify([]));
                localStorage.setItem('lancamentos', JSON.stringify([]));
                localStorage.setItem('auditLogs', JSON.stringify([]));
                
                console.log('Dados padr√£o inicializados com sucesso!');
            }
            
            // Recarregar dados do localStorage
            users = JSON.parse(localStorage.getItem('users') || '[]');
            investors = JSON.parse(localStorage.getItem('investors') || '[]');
            agents = JSON.parse(localStorage.getItem('agents') || '[]');
            ssaAccounts = JSON.parse(localStorage.getItem('ssaAccounts') || '[]');
            ssaTransactions = JSON.parse(localStorage.getItem('ssaTransactions') || '[]');
            subchannels = JSON.parse(localStorage.getItem('subchannels') || '[]');
            approvals = JSON.parse(localStorage.getItem('approvals') || '[]');
            transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            planoContas = JSON.parse(localStorage.getItem('planoContas') || '[]');
            lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
            auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
        }

        // ========== FUN√á√ïES DO PLANO DE CONTAS ==========
        function importPlanoContasFromCSV() {
            console.log('Importando plano de contas do CSV...');
            
            const lines = planoContasCSV.split('\n');
            const headers = lines[0].split(',');
            
            const importedContas = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',');
                if (values.length >= 4) {
                    const conta = {
                        id: parseInt(values[0]) || Date.now() + i,
                        codigo: values[1] || '',
                        nome: values[2] || '',
                        tipo: values[3] || '',
                        descricao: values[4] || '',
                        classe: values[5] || '',
                        parentId: null
                    };
                    
                    importedContas.push(conta);
                }
            }
            
            planoContas = importedContas;
            localStorage.setItem('planoContas', JSON.stringify(planoContas));
            
            console.log(`Plano de contas importado com ${planoContas.length} contas`);
            renderPlanoContasTree();
            
            // Registrar log de auditoria
            logAudit('IMPORT_PLANO_CONTAS', `Importou ${planoContas.length} contas do CSV`);
        }

        function importPlanoContas() {
            const fileInput = document.getElementById('importPlanoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo CSV');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    const headers = lines[0].split(',');
                    
                    const importedContas = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = line.split(',');
                        if (values.length >= 4) {
                            const conta = {
                                id: parseInt(values[0]) || Date.now() + i,
                                codigo: values[1] || '',
                                nome: values[2] || '',
                                tipo: values[3] || '',
                                descricao: values[4] || '',
                                classe: values[5] || '',
                                parentId: null
                            };
                            
                            importedContas.push(conta);
                        }
                    }
                    
                    planoContas = importedContas;
                    localStorage.setItem('planoContas', JSON.stringify(planoContas));
                    
                    renderPlanoContasTree();
                    loadPlanoContasForDropdown();
                    
                    alert(`Plano de contas importado com sucesso! ${planoContas.length} contas carregadas.`);
                    
                    // Registrar log de auditoria
                    logAudit('IMPORT_PLANO_CONTAS_FILE', `Importou ${planoContas.length} contas de arquivo`);
                    
                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportPlanoContas() {
            let csvContent = 'Codigo,Nome,Tipo,Descricao,Classe\n';
            
            planoContas.forEach(conta => {
                csvContent += `"${conta.codigo}","${conta.nome}","${conta.tipo}","${conta.descricao}","${conta.classe}"\n`;
            });
            
            const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadFile(dataBlob, `plano_contas_${Date.now()}.csv`);
            
            // Registrar log de auditoria
            logAudit('EXPORT_PLANO_CONTAS', 'Exportou plano de contas para CSV');
        }

        function renderPlanoContasTree() {
            const container = document.getElementById('planoContasTree');
            if (!container) return;
            
            // Agrupar contas por classe
            const contasPorClasse = {};
            planoContas.forEach(conta => {
                if (!contasPorClasse[conta.classe]) {
                    contasPorClasse[conta.classe] = [];
                }
                contasPorClasse[conta.classe].push(conta);
            });
            
            let html = '';
            
            // Renderizar por classe
            Object.keys(contasPorClasse).sort().forEach(classe => {
                html += `<div class="account-class">Classe ${classe}</div>`;
                
                contasPorClasse[classe].forEach(conta => {
                    html += `
                        <div class="account-item">
                            <div class="account-code">${conta.codigo}</div>
                            <div><strong>${conta.nome}</strong></div>
                            <div class="small muted">${conta.tipo} - ${conta.descricao}</div>
                            <div style="margin-top: 5px;">
                                <button class="btn btn-small btn-primary" onclick="editConta(${conta.id})">Editar</button>
                                <button class="btn btn-small btn-danger" onclick="deleteConta(${conta.id})">Eliminar</button>
                            </div>
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html || '<p style="text-align: center; color: #6c757d;">Nenhuma conta cadastrada</p>';
        }

        function saveConta(event) {
            if (event) event.preventDefault();
            
            const id = document.getElementById('contaId').value;
            const codigo = document.getElementById('contaCodigo').value;
            const nome = document.getElementById('contaNome').value;
            const tipo = document.getElementById('contaTipo').value;
            const descricao = document.getElementById('contaDescricao').value;
            const parentId = document.getElementById('contaPai').value || null;
            
            if (id) {
                // Atualizar conta existente
                const index = planoContas.findIndex(conta => conta.id == id);
                if (index !== -1) {
                    planoContas[index] = { 
                        ...planoContas[index], 
                        codigo, nome, tipo, descricao, parentId
                    };
                }
            } else {
                // Criar nova conta
                const newConta = {
                    id: Date.now(),
                    codigo,
                    nome,
                    tipo,
                    descricao,
                    classe: codigo.split('.')[0] || '0',
                    parentId
                };
                
                planoContas.push(newConta);
                
                // Registrar log de auditoria
                logAudit('CREATE_CONTA', `Criou conta: ${codigo} - ${nome}`);
            }
            
            localStorage.setItem('planoContas', JSON.stringify(planoContas));
            renderPlanoContasTree();
            loadPlanoContasForDropdown();
            closeModal('novaConta');
            
            alert(id ? 'Conta atualizada com sucesso!' : 'Conta criada com sucesso!');
        }

        function editConta(id) {
            const conta = planoContas.find(conta => conta.id === id);
            if (conta) {
                document.getElementById('contaId').value = conta.id;
                document.getElementById('contaCodigo').value = conta.codigo;
                document.getElementById('contaNome').value = conta.nome;
                document.getElementById('contaTipo').value = conta.tipo;
                document.getElementById('contaDescricao').value = conta.descricao || '';
                document.getElementById('contaPai').value = conta.parentId || '';
                
                showModal('novaConta');
            }
        }

        function deleteConta(id) {
            if (confirm('Tem certeza que deseja eliminar esta conta?')) {
                planoContas = planoContas.filter(conta => conta.id !== id);
                localStorage.setItem('planoContas', JSON.stringify(planoContas));
                renderPlanoContasTree();
                loadPlanoContasForDropdown();
                
                // Registrar log de auditoria
                logAudit('DELETE_CONTA', `Eliminou conta com ID: ${id}`);
            }
        }

        function loadPlanoContasForDropdown() {
            const debitoSelect = document.getElementById('lancamentoDebito');
            const creditoSelect = document.getElementById('lancamentoCredito');
            const contaPaiSelect = document.getElementById('contaPai');
            const filterContaSelect = document.getElementById('filterConta');
            
            // Limpar selects
            [debitoSelect, creditoSelect, contaPaiSelect, filterContaSelect].forEach(select => {
                if (select) {
                    select.innerHTML = select.id === 'contaPai' 
                        ? '<option value="">Nenhuma (Conta Principal)</option>'
                        : '<option value="">Selecionar conta</option>';
                }
            });
            
            // Popular selects
            planoContas.forEach(conta => {
                const optionText = `${conta.codigo} - ${conta.nome}`;
                
                [debitoSelect, creditoSelect, contaPaiSelect, filterContaSelect].forEach(select => {
                    if (select) {
                        const option = document.createElement('option');
                        option.value = conta.id;
                        option.textContent = optionText;
                        select.appendChild(option);
                    }
                });
            });
        }

        // ========== FUN√á√ïES DE LAN√áAMENTOS CONT√ÅBEIS ==========
        function saveLancamento(event) {
            if (event) event.preventDefault();
            
            const data = document.getElementById('lancamentoData').value;
            const descricao = document.getElementById('lancamentoDescricao').value;
            const contaDebitoId = document.getElementById('lancamentoDebito').value;
            const contaCreditoId = document.getElementById('lancamentoCredito').value;
            const valor = parseFloat(document.getElementById('lancamentoValor').value);
            
            if (!data || !descricao || !contaDebitoId || !contaCreditoId || !valor) {
                alert('Por favor, preencha todos os campos obrigat√≥rios');
                return;
            }
            
            if (contaDebitoId === contaCreditoId) {
                alert('A conta d√©bito e cr√©dito n√£o podem ser a mesma');
                return;
            }
            
            const contaDebito = planoContas.find(c => c.id == contaDebitoId);
            const contaCredito = planoContas.find(c => c.id == contaCreditoId);
            
            const lancamento = {
                id: Date.now(),
                data,
                descricao,
                contaDebito: contaDebitoId,
                contaDebitoNome: contaDebito ? `${contaDebito.codigo} - ${contaDebito.nome}` : '',
                contaCredito: contaCreditoId,
                contaCreditoNome: contaCredito ? `${contaCredito.codigo} - ${contaCredito.nome}` : '',
                valor,
                userId: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            lancamentos.push(lancamento);
            localStorage.setItem('lancamentos', JSON.stringify(lancamentos));
            
            // Registrar log de auditoria
            logAudit('CREATE_LANCAMENTO', `Criou lan√ßamento: ${descricao} - MT ${valor.toFixed(2)}`);
            
            alert('Lan√ßamento registado com sucesso!');
            document.getElementById('lancamentoForm').reset();
            document.getElementById('lancamentoData').value = new Date().toISOString().split('T')[0];
            
            filtrarLancamentos();
        }

        function filtrarLancamentos() {
            const tbody = document.getElementById('lancamentosTable').querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            let filteredLancamentos = [...lancamentos];
            
            // Aplicar filtros
            const dataInicio = document.getElementById('filterDataInicio').value;
            const dataFim = document.getElementById('filterDataFim').value;
            const contaFilter = document.getElementById('filterConta').value;
            
            if (dataInicio) {
                filteredLancamentos = filteredLancamentos.filter(l => l.data >= dataInicio);
            }
            
            if (dataFim) {
                filteredLancamentos = filteredLancamentos.filter(l => l.data <= dataFim);
            }
            
            if (contaFilter) {
                filteredLancamentos = filteredLancamentos.filter(l => 
                    l.contaDebito == contaFilter || l.contaCredito == contaFilter
                );
            }
            
            // Ordenar por data (mais recente primeiro)
            filteredLancamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            filteredLancamentos.forEach(lancamento => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lancamento.data}</td>
                    <td>${lancamento.descricao}</td>
                    <td>${lancamento.contaDebitoNome}</td>
                    <td>${lancamento.contaCreditoNome}</td>
                    <td>MT ${lancamento.valor.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (filteredLancamentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">Nenhum lan√ßamento encontrado</td></tr>';
            }
        }

        // ========== FUN√á√ïES DE RELAT√ìRIOS ==========
        function generateBalanceSheet() {
            const reportResult = document.getElementById('reportResult');
            if (!reportResult) return;
            
            let html = '<h3>Balan√ßo Patrimonial</h3>';
            
            // Calcular totais por tipo
            const totaisPorTipo = {};
            planoContas.forEach(conta => {
                if (!totaisPorTipo[conta.tipo]) {
                    totaisPorTipo[conta.tipo] = 0;
                }
                
                // Simular saldos (em produ√ß√£o, isto viria dos lan√ßamentos)
                const saldo = Math.random() * 10000;
                totaisPorTipo[conta.tipo] += saldo;
            });
            
            html += '<div class="grid grid-2" style="margin-top: 20px;">';
            html += '<div><h4>Ativo</h4><div style="font-size: 24px; color: green;">MT ' + (totaisPorTipo['Ativo'] || 0).toFixed(2) + '</div></div>';
            html += '<div><h4>Passivo + Patrim√¥nio</h4><div style="font-size: 24px; color: blue;">MT ' + ((totaisPorTipo['Passivo'] || 0) + (totaisPorTipo['Patrimonio'] || 0)).toFixed(2) + '</div></div>';
            html += '</div>';
            
            reportResult.innerHTML = html;
        }

        function generateIncomeStatement() {
            const reportResult = document.getElementById('reportResult');
            if (!reportResult) return;
            
            let html = '<h3>Demonstra√ß√£o de Resultados</h3>';
            
            // Simular dados
            const receitas = 150000;
            const despesas = 120000;
            const lucro = receitas - despesas;
            
            html += `
                <div style="margin-top: 20px;">
                    <div class="result-item">
                        <h3>Receitas Totais</h3>
                        <div class="kpi" style="color: green;">MT ${receitas.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <h3>Despesas Totais</h3>
                        <div class="kpi" style="color: red;">MT ${despesas.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <h3>Resultado L√≠quido</h3>
                        <div class="kpi" style="color: ${lucro >= 0 ? 'green' : 'red'};">MT ${lucro.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            reportResult.innerHTML = html;
        }

        function generateCashFlow() {
            const reportResult = document.getElementById('reportResult');
            if (!reportResult) return;
            
            let html = '<h3>Fluxo de Caixa</h3>';
            
            // Simular dados
            const entradas = 80000;
            const saidas = 75000;
            const saldo = entradas - saidas;
            
            html += `
                <div style="margin-top: 20px;">
                    <div class="result-item">
                        <h3>Entradas</h3>
                        <div class="kpi" style="color: green;">MT ${entradas.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <h3>Sa√≠das</h3>
                        <div class="kpi" style="color: red;">MT ${saidas.toFixed(2)}</div>
                    </div>
                    <div class="result-item">
                        <h3>Saldo Final</h3>
                        <div class="kpi" style="color: ${saldo >= 0 ? 'green' : 'red'};">MT ${saldo.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            reportResult.innerHTML = html;
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function getRoleName(role) {
            const roles = {
                'admin': 'Administrador',
                'manager': 'Gestor',
                'accountant': 'Contabilista',
                'operator': 'Operador',
                'viewer': 'Visualizador'
            };
            return roles[role] || 'Utilizador';
        }

        function calculateBusinessDays(startDate, endDate) {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function logAudit(action, details) {
            if (!currentUser) return;
            
            const auditLog = {
                id: Date.now(),
                userId: currentUser.id,
                username: currentUser.username,
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                ip: '127.0.0.1'
            };
            
            auditLogs.push(auditLog);
            
            if (auditLogs.length > 1000) {
                auditLogs = auditLogs.slice(-1000);
            }
            
            localStorage.setItem('auditLogs', JSON.stringify(auditLogs));
        }

        // ========== INICIALIZA√á√ÉO DO SISTEMA ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar dados padr√£o
            initializeDefaultData();
            
            // Configurar event listeners
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('investorForm').addEventListener('submit', saveInvestor);
            document.getElementById('agentForm').addEventListener('submit', saveAgent);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            document.getElementById('ssaAccountForm').addEventListener('submit', saveSSAAccount);
            document.getElementById('contaForm').addEventListener('submit', saveConta);
            document.getElementById('lancamentoForm').addEventListener('submit', saveLancamento);
            
            // Configurar data atual nos formul√°rios
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('investorStartDate').value = today;
            document.getElementById('txnDate').value = today;
            document.getElementById('lancamentoData').value = today;
            document.getElementById('ssaDepositDate').value = today;
            document.getElementById('ssaReceiveDate').value = today;
            
            // Carregar plano de contas se existir
            if (planoContas.length > 0) {
                renderPlanoContasTree();
                loadPlanoContasForDropdown();
            }
            
            console.log('Sistema Great Mola inicializado com sucesso!');
        });

        // ========== FUN√á√ïES DE NAVEGA√á√ÉO ==========
        function switchTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Ativar bot√£o selecionado
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Atualizar dados espec√≠ficos da tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'accounting') {
                updateAccountingData();
            } else if (tabName === 'investors') {
                updateInvestorsTable();
            } else if (tabName === 'agents') {
                updateAgentsTable();
                loadAgentsForDropdown();
            } else if (tabName === 'users') {
                updateUsersTable();
                updateAuditLogs();
            } else if (tabName === 'ssa') {
                updateSSAAccountsTable();
                updateSubchannelsTable();
                loadSSAForDropdowns();
            }
        }

        function switchSubTab(subTabName) {
            // Esconder todos os sub-conte√∫dos
            document.querySelectorAll('.sub-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.sub-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar sub-tab selecionada
            const element = document.getElementById(subTabName);
            if (element) {
                element.classList.add('active');
            }
            
            // Ativar bot√£o selecionado
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // A√ß√µes espec√≠ficas para sub-tabs
            if (subTabName === 'chartOfAccounts') {
                renderPlanoContasTree();
            } else if (subTabName === 'accountingEntries') {
                filtrarLancamentos();
            }
        }

        // ... (o resto das fun√ß√µes permanece igual) ...
    </script>
</body>
</html>
