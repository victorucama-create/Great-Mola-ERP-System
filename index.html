<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Great Mola - Sistema Completo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíº</text></svg>" type="image/svg+xml">
    <style>
        :root {
            --primary: #c81f1f;
            --secondary: #007bff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --muted: #666;
            --bg: #f5f7fb;
            --card: #fff;
            --accent: #ffbe21;
            --blue: #007bff;
            --orange: #fd7e14;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            background: var(--light);
            border-bottom: 2px solid #dee2e6;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: white;
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #a61c1c;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-ghost {
            background: transparent;
            border: 1px solid #d6dbe8;
            color: var(--dark);
        }
        
        .btn-small {
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 8px;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .grid-4 {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
        
        .kpi-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .kpi-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .kpi-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: var(--light);
            font-weight: 600;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d1edff;
            color: #0c5460;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-active {
            background: #d1edff;
            color: #0c5460;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .badge-admin {
            background: var(--danger);
            color: #fff;
        }
        
        .badge-manager {
            background: var(--orange);
            color: #fff;
        }
        
        .badge-analyst {
            background: var(--success);
            color: #fff;
        }
        
        .badge-agent {
            background: #6f42c1;
            color: #fff;
        }
        
        .badge-investor {
            background: var(--secondary);
            color: #fff;
        }
        
        .alert {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }
        
        .muted {
            color: var(--muted);
            font-size: 13px;
        }
        
        .small {
            font-size: 13px;
            color: var(--muted);
        }
        
        .inline {
            display: inline-block;
            width: auto;
        }
        
        input[type=file] {
            padding: 6px;
        }
        
        .footer {
            font-size: 13px;
            color: var(--muted);
            margin-top: 16px;
            text-align: center;
            padding: 20px;
        }
        
        .results-row {
            display: flex;
            gap: 10px;
            align-items: stretch;
            flex-wrap: wrap;
        }
        
        .result-item {
            flex: 1;
            min-width: 180px;
            padding: 12px;
            border-radius: 8px;
            background: linear-gradient(180deg,#fff,#fbfdff);
            border: 1px solid #eef2f8;
        }
        
        .result-item h3 {
            margin: 0;
            font-size: 14px;
        }
        
        .kpi {
            font-size: 18px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .note {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }
        
        .sub-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sub-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .sub-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .sub-content {
            display: none;
        }
        
        .sub-content.active {
            display: block;
        }
        
        .account-tree {
            margin-left: 20px;
        }
        
        .account-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .account-code {
            font-weight: bold;
            color: var(--primary);
        }
        
        .account-class {
            font-weight: bold;
            color: var(--dark);
            margin-top: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary);
        }
        
        .account-group {
            font-weight: 600;
            color: var(--muted);
            margin-top: 10px;
            padding-left: 10px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .password-toggle {
            position: relative;
        }
        
        .password-toggle input {
            padding-right: 40px;
        }
        
        .password-toggle .toggle-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--muted);
        }
        
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .permission-item input {
            width: auto;
        }
        
        .permission-category {
            font-weight: bold;
            margin-top: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
            grid-column: 1 / -1;
        }
        
        .file-upload {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: var(--secondary);
            background-color: #f8f9fa;
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-preview {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .file-preview-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .file-preview-item .remove-file {
            color: var(--danger);
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Novos estilos para relat√≥rios financeiros */
        .report-filters {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .report-period {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .report-options {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .report-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .report-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .report-table tr.group-header {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .report-table tr.total-row {
            background: #e9ecef;
            font-weight: bold;
        }
        
        .report-table tr.subtotal-row {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .amount-positive {
            color: var(--success);
        }
        
        .amount-negative {
            color: var(--danger);
        }
        
        .amount-zero {
            color: var(--muted);
        }
        
        .report-drilldown {
            cursor: pointer;
            color: var(--secondary);
            text-decoration: underline;
        }
        
        .report-drilldown:hover {
            color: var(--primary);
        }
        
        .comparison-indicator {
            font-size: 12px;
            margin-left: 5px;
        }
        
        .comparison-positive {
            color: var(--success);
        }
        
        .comparison-negative {
            color: var(--danger);
        }
        
        .report-chart {
            margin-top: 20px;
            height: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .results-row {
                flex-direction: column;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .permissions-grid {
                grid-template-columns: 1fr;
            }
            
            .report-controls, .report-period, .report-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .report-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div style="margin-bottom: 30px;">
            <div style="font-size: 48px; color: var(--primary); margin-bottom: 10px;">üíº</div>
            <h1 style="color: var(--primary); margin-bottom: 10px;">Great Mola</h1>
            <p style="color: var(--dark); opacity: 0.7;">Sistema Integrado de Gest√£o</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label>Utilizador</label>
                <input type="text" id="username" placeholder="Nome de utilizador" required>
            </div>
            
            <div class="form-group">
                <label>Palavra-passe</label>
                <input type="password" id="password" placeholder="Palavra-passe" required>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar no Sistema</button>
        </form>
        
        <div class="alert" style="margin-top: 20px;">
            <strong>Primeiro Acesso:</strong> Utilize admin / admin123
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="app" class="container" style="display: none;">
        <!-- Cabe√ßalho -->
        <div class="header">
            <div class="logo">Great Mola üíº - Sistema Completo</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">Utilizador</div>
                        <div style="font-size: 12px; opacity: 0.8;" id="userRole">Admin</div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="exportBackup()">üíæ Backup</button>
                <button class="btn btn-secondary" onclick="importBackup()">üì• Restaurar</button>
                <button class="btn btn-warning" onclick="logout()" style="margin-left: 15px;">Sair</button>
            </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('accounting')">üìà Contabilidade & Finan√ßas</button>
            <button class="nav-tab" onclick="switchTab('investors')">üë• Investidores</button>
            <button class="nav-tab" onclick="switchTab('agents')">ü§ù Agentes</button>
            <button class="nav-tab" onclick="switchTab('users')" id="usersTab" style="display: none;">üë§ Utilizadores</button>
            <button class="nav-tab" onclick="switchTab('approvals')" id="approvalsTab" style="display: none;">‚úÖ Aprova√ß√µes</button>
            <button class="nav-tab" onclick="switchTab('ssa')" id="ssaTab" style="display: none;">üíº SSA</button>
            <button class="nav-tab" onclick="switchTab('settings')" id="settingsTab" style="display: none;">‚öôÔ∏è Configura√ß√µes</button>
        </div>

        <!-- Conte√∫do das Tabs -->
        <div class="tab-content active" id="dashboard">
            <h2>Dashboard do Sistema</h2>
            <div class="grid grid-3">
                <div class="kpi-card">
                    <div class="kpi-label">Total Investido</div>
                    <div class="kpi-value" id="totalInvested">MT 0.00</div>
                    <div class="kpi-label">Por todos os investidores</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Comiss√µes Pendentes</div>
                    <div class="kpi-value" id="pendingCommissions">MT 0.00</div>
                    <div class="kpi-label">Aguardando pagamento</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Aprova√ß√µes</div>
                    <div class="kpi-value" id="pendingApprovals">0</div>
                    <div class="kpi-label">Aguardando revis√£o</div>
                </div>
            </div>

            <div class="grid grid-2" style="margin-top: 30px;">
                <div class="card">
                    <h3>üìà Meus Investimentos</h3>
                    <div id="myInvestmentsList">
                        <p style="color: #6c757d; text-align: center; padding: 20px;">
                            Carregando seus investimentos...
                        </p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üí∞ Minhas Comiss√µes</h3>
                    <div id="myCommissionsList">
                        <p style="color: #6c757d; text-align: center; padding: 20px;">
                            Carregando suas comiss√µes...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Contabilidade & Finan√ßas -->
        <div class="tab-content" id="accounting">
            <h2>Contabilidade & Finan√ßas</h2>
            
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('planning')">Planejamento Financeiro</button>
                <button class="sub-tab" onclick="switchSubTab('chartOfAccounts')">Plano de Contas</button>
                <button class="sub-tab" onclick="switchSubTab('reports')">Relat√≥rios Financeiros</button>
                <button class="sub-tab" onclick="switchSubTab('transactions')">Di√°rio de Movimentos</button>
                <button class="sub-tab" onclick="switchSubTab('internalControl')">Controlo Interno</button>
                <button class="sub-tab" onclick="switchSubTab('accountingEntries')">Lan√ßamentos</button>
            </div>
            
            <!-- Sub-tab Planejamento Financeiro -->
            <div class="sub-content active" id="planning">
                <!-- Conte√∫do existente... -->
            </div>
            
            <!-- Sub-tab Plano de Contas -->
            <div class="sub-content" id="chartOfAccounts">
                <!-- Conte√∫do existente... -->
            </div>
            
            <!-- Sub-tab Relat√≥rios Financeiros (MELHORADO) -->
            <div class="sub-content" id="reports">
                <div class="card">
                    <h3>üìä Relat√≥rios Financeiros</h3>
                    
                    <!-- Filtros de Relat√≥rios -->
                    <div class="report-filters">
                        <div class="report-controls">
                            <div class="report-period">
                                <div class="filter-group">
                                    <label>Data In√≠cio</label>
                                    <input type="date" id="reportStartDate" value="">
                                </div>
                                <div class="filter-group">
                                    <label>Data Fim</label>
                                    <input type="date" id="reportEndDate" value="">
                                </div>
                                <div class="filter-group">
                                    <label>Per√≠odo R√°pido</label>
                                    <select id="quickPeriod" onchange="setQuickPeriod()">
                                        <option value="custom">Personalizado</option>
                                        <option value="thisMonth">Este M√™s</option>
                                        <option value="lastMonth">M√™s Anterior</option>
                                        <option value="thisQuarter">Este Trimestre</option>
                                        <option value="lastQuarter">Trimestre Anterior</option>
                                        <option value="thisYear">Este Ano</option>
                                        <option value="lastYear">Ano Anterior</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="report-options">
                                <div class="filter-group">
                                    <label>Comparar com</label>
                                    <select id="compareWith">
                                        <option value="none">Nenhum</option>
                                        <option value="previousPeriod">Per√≠odo Anterior</option>
                                        <option value="previousYear">Mesmo Per√≠odo Ano Anterior</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Moeda</label>
                                    <select id="reportCurrency">
                                        <option value="MZN">MZN - Metical</option>
                                        <option value="USD">USD - D√≥lar Americano</option>
                                        <option value="EUR">EUR - Euro</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Arredondamento</label>
                                    <select id="roundingOption">
                                        <option value="normal">Normal (2 casas)</option>
                                        <option value="thousands">Milhares (K)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="generateReport('trialBalance')">üìã Balancete</button>
                            <button class="btn btn-primary" onclick="generateReport('balanceSheet')">üìä Balan√ßo</button>
                            <button class="btn btn-primary" onclick="generateReport('incomeStatement')">üìà DRE</button>
                            <button class="btn btn-primary" onclick="generateReport('cashFlow')">üí∞ Fluxo de Caixa</button>
                            <button class="btn btn-secondary" onclick="clearReport()">üîÑ Limpar</button>
                        </div>
                    </div>
                    
                    <!-- Resumo de KPIs -->
                    <div class="report-summary" id="reportSummary" style="display: none;">
                        <div class="result-item">
                            <h3>Total Ativos</h3>
                            <div class="kpi" id="summaryTotalAssets">MT 0.00</div>
                        </div>
                        <div class="result-item">
                            <h3>Total Passivos</h3>
                            <div class="kpi" id="summaryTotalLiabilities">MT 0.00</div>
                        </div>
                        <div class="result-item">
                            <h3>Patrim√¥nio L√≠quido</h3>
                            <div class="kpi" id="summaryTotalEquity">MT 0.00</div>
                        </div>
                        <div class="result-item">
                            <h3>Resultado L√≠quido</h3>
                            <div class="kpi" id="summaryNetIncome">MT 0.00</div>
                        </div>
                    </div>
                    
                    <!-- Resultados do Relat√≥rio -->
                    <div id="reportResult">
                        <p style="color: #6c757d; text-align: center; padding: 40px;">
                            Selecione um tipo de relat√≥rio e per√≠odo para gerar o relat√≥rio financeiro.
                        </p>
                    </div>
                    
                    <!-- Gr√°fico (placeholder) -->
                    <div class="report-chart" id="reportChart" style="display: none;">
                        Gr√°fico do relat√≥rio ser√° exibido aqui
                    </div>
                    
                    <!-- Bot√µes de Exporta√ß√£o -->
                    <div class="export-buttons" id="exportButtons" style="display: none;">
                        <button class="btn btn-secondary" onclick="exportReport('excel')">üìä Exportar Excel</button>
                        <button class="btn btn-success" onclick="exportReport('csv')">üìÑ Exportar CSV</button>
                        <button class="btn btn-primary" onclick="exportReport('pdf')">üìë Exportar PDF</button>
                        <button class="btn btn-warning" onclick="printReport()">üñ®Ô∏è Imprimir</button>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab Di√°rio de Movimentos -->
            <div class="sub-content" id="transactions">
                <!-- Conte√∫do existente... -->
            </div>
            
            <!-- Sub-tab Controlo Interno -->
            <div class="sub-content" id="internalControl">
                <!-- Conte√∫do existente... -->
            </div>
            
            <!-- Sub-tab Lan√ßamentos -->
            <div class="sub-content" id="accountingEntries">
                <!-- Conte√∫do existente... -->
            </div>
        </div>

        <!-- Resto do c√≥digo permanece igual -->
        <!-- ... (outras abas) ... -->
    </div>

    <!-- Modais -->
    <div id="novaConta" class="modal">
        <!-- Conte√∫do existente... -->
    </div>

    <div id="permissionsModal" class="modal">
        <!-- Conte√∫do existente... -->
    </div>

    <!-- Modal para Drill-down -->
    <div id="drilldownModal" class="modal">
        <div class="modal-content" style="max-width: 90%;">
            <div class="modal-header">
                <h3 id="drilldownTitle">Detalhes do Lan√ßamento</h3>
                <span class="close" onclick="closeModal('drilldownModal')">&times;</span>
            </div>
            <div id="drilldownContent">
                <!-- Conte√∫do ser√° carregado dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let currentUser = null;
        let users = [];
        let roles = [];
        let investors = [];
        let agents = [];
        let ssaAccounts = [];
        let stAccounts = [];
        let afAccounts = [];
        let ssaTransactions = [];
        let subchannels = [];
        let approvals = [];
        let transactions = [];
        let planoContas = [];
        let lancamentos = [];
        let auditLogs = [];
        let settings = {};
        
        // Mapeamento de contas para relat√≥rios
        const accountMapping = {
            "balance_sheet": {
                "assets": ["111","112","113","114","115","116","117","118","121","122","123","124","211","212","213","214","231","232","233"],
                "liabilities": ["321","322","323","421","422","423","424","431","432","433","434"],
                "equity": ["511","512","521","522","523","531","532","541","542"]
            },
            "income_statement": {
                "revenues": ["711","712","713","721","722","723","734","735","736"],
                "expenses": ["611","612","613","614","621","622","623","624","631","632","633","641","642","643","644","651","652","653","6451"]
            },
            "cash_accounts": ["111","113","114","115","116","117"]
        };
        
        // ========== INICIALIZA√á√ÉO DE DADOS PADR√ÉO ==========
        function initializeDefaultData() {
            console.log('Inicializando dados padr√£o...');
            
            // Verificar se j√° existem dados no localStorage
            const storedUsers = localStorage.getItem('users');
            
            if (!storedUsers) {
                console.log('Criando dados padr√£o...');
                
                // Criar apenas um usu√°rio administrador padr√£o
                users = [
                    {
                        id: 1,
                        fullName: 'Administrador',
                        username: 'admin',
                        password: 'admin123',
                        role: 'admin',
                        status: 'Ativo',
                        createdAt: new Date().toISOString(),
                        lastAccess: null
                    }
                ];

                localStorage.setItem('users', JSON.stringify(users));
                
                // Inicializar fun√ß√µes padr√£o
                initializeDefaultRoles();
                
                // Inicializar outras estruturas de dados vazias
                localStorage.setItem('investors', JSON.stringify([]));
                localStorage.setItem('agents', JSON.stringify([]));
                localStorage.setItem('ssaAccounts', JSON.stringify([]));
                localStorage.setItem('stAccounts', JSON.stringify([]));
                localStorage.setItem('afAccounts', JSON.stringify([]));
                localStorage.setItem('ssaTransactions', JSON.stringify([]));
                localStorage.setItem('subchannels', JSON.stringify([]));
                localStorage.setItem('approvals', JSON.stringify([]));
                localStorage.setItem('transactions', JSON.stringify([]));
                localStorage.setItem('planoContas', JSON.stringify([]));
                localStorage.setItem('lancamentos', JSON.stringify([]));
                localStorage.setItem('auditLogs', JSON.stringify([]));
                
                // Inicializar configura√ß√µes padr√£o
                initializeDefaultSettings();
                
                console.log('Dados padr√£o inicializados com sucesso!');
            } else {
                console.log('Dados j√° existentes, carregando do localStorage...');
                users = JSON.parse(storedUsers);
            }
            
            // Recarregar dados do localStorage
            loadAllDataFromLocalStorage();
            
            // Verificar se o plano de contas est√° vazio e carregar o padr√£o
            if (planoContas.length === 0) {
                loadDefaultPlanoContas();
            }
            
            // Garantir que as fun√ß√µes est√£o inicializadas
            if (roles.length === 0) {
                initializeDefaultRoles();
            }
            
            // Configurar datas padr√£o para relat√≥rios
            setupReportDates();
        }

        function setupReportDates() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('reportStartDate').value = startOfMonth.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endOfMonth.toISOString().split('T')[0];
        }

        function setQuickPeriod() {
            const quickPeriod = document.getElementById('quickPeriod').value;
            const today = new Date();
            let startDate, endDate;
            
            switch(quickPeriod) {
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'thisQuarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
                    break;
                case 'lastQuarter':
                    const lastQuarter = Math.floor(today.getMonth() / 3) - 1;
                    startDate = new Date(today.getFullYear(), lastQuarter * 3, 1);
                    endDate = new Date(today.getFullYear(), (lastQuarter + 1) * 3, 0);
                    break;
                case 'thisYear':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'lastYear':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    break;
                default:
                    return; // Personalizado - n√£o alterar datas
            }
            
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
        }

        // ========== FUN√á√ïES DE RELAT√ìRIOS FINANCEIROS ==========
        function generateReport(reportType) {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const compareWith = document.getElementById('compareWith').value;
            const currency = document.getElementById('reportCurrency').value;
            const rounding = document.getElementById('roundingOption').value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecione um per√≠odo v√°lido!');
                return;
            }
            
            // Registrar log de auditoria
            logAudit('GENERATE_REPORT', `Gerou relat√≥rio ${reportType} de ${startDate} a ${endDate}`);
            
            switch(reportType) {
                case 'trialBalance':
                    generateTrialBalance(startDate, endDate, compareWith, currency, rounding);
                    break;
                case 'balanceSheet':
                    generateBalanceSheet(endDate, compareWith, currency, rounding);
                    break;
                case 'incomeStatement':
                    generateIncomeStatement(startDate, endDate, compareWith, currency, rounding);
                    break;
                case 'cashFlow':
                    generateCashFlow(startDate, endDate, compareWith, currency, rounding);
                    break;
            }
            
            // Mostrar elementos de exporta√ß√£o
            document.getElementById('exportButtons').style.display = 'flex';
            document.getElementById('reportChart').style.display = 'flex';
        }

        function generateTrialBalance(startDate, endDate, compareWith, currency, rounding) {
            // Calcular saldos iniciais (at√© startDate - 1)
            const initialBalances = calculateAccountBalances(null, new Date(startDate));
            initialBalances.date = new Date(startDate);
            
            // Calcular movimentos do per√≠odo
            const periodMovements = calculateAccountMovements(new Date(startDate), new Date(endDate));
            
            // Calcular saldos finais
            const finalBalances = calculateAccountBalances(new Date(startDate), new Date(endDate));
            finalBalances.date = new Date(endDate);
            
            // Gerar HTML do relat√≥rio
            let html = `
                <h3>üìã Balancete de Verifica√ß√£o</h3>
                <p class="small muted">Per√≠odo: ${formatDate(new Date(startDate))} a ${formatDate(new Date(endDate))}</p>
                
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Conta</th>
                            <th>Saldo Inicial (D/C)</th>
                            <th>D√©bitos no Per√≠odo</th>
                            <th>Cr√©ditos no Per√≠odo</th>
                            <th>Saldo Final (D/C)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalInitialDebit = 0;
            let totalInitialCredit = 0;
            let totalPeriodDebit = 0;
            let totalPeriodCredit = 0;
            let totalFinalDebit = 0;
            let totalFinalCredit = 0;
            
            // Agrupar contas por classe
            const accountsByClass = {};
            planoContas.forEach(conta => {
                const classCode = conta.codigo.split('.')[0];
                if (!accountsByClass[classCode]) {
                    accountsByClass[classCode] = [];
                }
                accountsByClass[classCode].push(conta);
            });
            
            // Processar cada classe
            Object.keys(accountsByClass).sort().forEach(classCode => {
                html += `<tr class="group-header"><td colspan="6">Classe ${classCode}</td></tr>`;
                
                accountsByClass[classCode].forEach(conta => {
                    const initialBalance = initialBalances[conta.id] || 0;
                    const periodMovement = periodMovements[conta.id] || { debit: 0, credit: 0 };
                    const finalBalance = finalBalances[conta.id] || 0;
                    
                    // Determinar se √© d√©bito ou cr√©dito
                    const isDebitAccount = ['Ativo', 'Despesa'].includes(conta.tipo);
                    const initialSign = isDebitAccount ? 
                        (initialBalance >= 0 ? 'D' : 'C') : 
                        (initialBalance >= 0 ? 'C' : 'D');
                    const finalSign = isDebitAccount ? 
                        (finalBalance >= 0 ? 'D' : 'C') : 
                        (finalBalance >= 0 ? 'C' : 'D');
                    
                    // Acumular totais
                    if (isDebitAccount) {
                        if (initialBalance >= 0) totalInitialDebit += Math.abs(initialBalance);
                        else totalInitialCredit += Math.abs(initialBalance);
                        
                        if (finalBalance >= 0) totalFinalDebit += Math.abs(finalBalance);
                        else totalFinalCredit += Math.abs(finalBalance);
                    } else {
                        if (initialBalance >= 0) totalInitialCredit += Math.abs(initialBalance);
                        else totalInitialDebit += Math.abs(initialBalance);
                        
                        if (finalBalance >= 0) totalFinalCredit += Math.abs(finalBalance);
                        else totalFinalDebit += Math.abs(finalBalance);
                    }
                    
                    totalPeriodDebit += periodMovement.debit;
                    totalPeriodCredit += periodMovement.credit;
                    
                    html += `
                        <tr>
                            <td>${conta.codigo}</td>
                            <td>${conta.nome}</td>
                            <td class="${getAmountClass(initialBalance)}">${formatCurrency(Math.abs(initialBalance), currency, rounding)} ${initialSign}</td>
                            <td class="amount-positive">${formatCurrency(periodMovement.debit, currency, rounding)}</td>
                            <td class="amount-negative">${formatCurrency(periodMovement.credit, currency, rounding)}</td>
                            <td class="${getAmountClass(finalBalance)}">
                                ${formatCurrency(Math.abs(finalBalance), currency, rounding)} ${finalSign}
                                <span class="report-drilldown" onclick="showAccountLedger(${conta.id}, '${startDate}', '${endDate}')">üîç</span>
                            </td>
                        </tr>
                    `;
                });
            });
            
            // Linha de totais
            html += `
                <tr class="total-row">
                    <td colspan="2"><strong>TOTAIS</strong></td>
                    <td><strong>${formatCurrency(totalInitialDebit, currency, rounding)} D / ${formatCurrency(totalInitialCredit, currency, rounding)} C</strong></td>
                    <td><strong class="amount-positive">${formatCurrency(totalPeriodDebit, currency, rounding)}</strong></td>
                    <td><strong class="amount-negative">${formatCurrency(totalPeriodCredit, currency, rounding)}</strong></td>
                    <td><strong>${formatCurrency(totalFinalDebit, currency, rounding)} D / ${formatCurrency(totalFinalCredit, currency, rounding)} C</strong></td>
                </tr>
            `;
            
            html += `</tbody></table>`;
            
            // Verifica√ß√£o de igualdade
            const initialBalanced = Math.abs(totalInitialDebit - totalInitialCredit) < 0.01;
            const periodBalanced = Math.abs(totalPeriodDebit - totalPeriodCredit) < 0.01;
            const finalBalanced = Math.abs(totalFinalDebit - totalFinalCredit) < 0.01;
            
            html += `
                <div style="margin-top: 20px;">
                    <div class="${initialBalanced ? 'success' : 'alert'}">
                        <strong>Saldo Inicial:</strong> ${initialBalanced ? '‚úì Equil√≠brio verificado' : '‚úó Desequil√≠brio detectado'}
                    </div>
                    <div class="${periodBalanced ? 'success' : 'alert'}">
                        <strong>Movimentos do Per√≠odo:</strong> ${periodBalanced ? '‚úì Equil√≠brio verificado' : '‚úó Desequil√≠brio detectado'}
                    </div>
                    <div class="${finalBalanced ? 'success' : 'alert'}">
                        <strong>Saldo Final:</strong> ${finalBalanced ? '‚úì Equil√≠brio verificado' : '‚úó Desequil√≠brio detectado'}
                    </div>
                </div>
            `;
            
            document.getElementById('reportResult').innerHTML = html;
            
            // Atualizar resumo
            updateReportSummary(finalBalances);
        }

        function generateBalanceSheet(asOfDate, compareWith, currency, rounding) {
            // Calcular saldos na data especificada
            const balances = calculateAccountBalances(null, new Date(asOfDate));
            
            // Gerar HTML do relat√≥rio
            let html = `
                <h3>üìä Balan√ßo Patrimonial</h3>
                <p class="small muted">Na data: ${formatDate(new Date(asOfDate))}</p>
                
                <div class="grid grid-2">
                    <div>
                        <h4>ATIVO</h4>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Conta</th>
                                    <th>Valor (${currency})</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Ativos
            let totalAssets = 0;
            const assetAccounts = accountMapping.balance_sheet.assets;
            
            assetAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const balance = balances[conta.id] || 0;
                    // Para ativos, saldo positivo √© normal
                    const displayBalance = balance >= 0 ? balance : -balance;
                    totalAssets += displayBalance;
                    
                    html += `
                        <tr>
                            <td>${conta.codigo} - ${conta.nome}</td>
                            <td class="${getAmountClass(displayBalance)}">
                                ${formatCurrency(displayBalance, currency, rounding)}
                                <span class="report-drilldown" onclick="showAccountLedger(${conta.id}, null, '${asOfDate}')">üîç</span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            html += `
                <tr class="total-row">
                    <td><strong>TOTAL DO ATIVO</strong></td>
                    <td><strong class="${getAmountClass(totalAssets)}">${formatCurrency(totalAssets, currency, rounding)}</strong></td>
                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div>
                        <h4>PASSIVO E PATRIM√îNIO L√çQUIDO</h4>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Conta</th>
                                    <th>Valor (${currency})</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Passivos
            let totalLiabilities = 0;
            const liabilityAccounts = accountMapping.balance_sheet.liabilities;
            
            liabilityAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const balance = balances[conta.id] || 0;
                    // Para passivos, saldo positivo √© normal
                    const displayBalance = balance >= 0 ? balance : -balance;
                    totalLiabilities += displayBalance;
                    
                    html += `
                        <tr>
                            <td>${conta.codigo} - ${conta.nome}</td>
                            <td class="${getAmountClass(displayBalance)}">
                                ${formatCurrency(displayBalance, currency, rounding)}
                                <span class="report-drilldown" onclick="showAccountLedger(${conta.id}, null, '${asOfDate}')">üîç</span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            // Patrim√¥nio L√≠quido
            let totalEquity = 0;
            const equityAccounts = accountMapping.balance_sheet.equity;
            
            html += `<tr class="group-header"><td colspan="2">PATRIM√îNIO L√çQUIDO</td></tr>`;
            
            equityAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const balance = balances[conta.id] || 0;
                    // Para patrim√¥nio, saldo positivo √© normal
                    const displayBalance = balance >= 0 ? balance : -balance;
                    totalEquity += displayBalance;
                    
                    html += `
                        <tr>
                            <td>${conta.codigo} - ${conta.nome}</td>
                            <td class="${getAmountClass(displayBalance)}">
                                ${formatCurrency(displayBalance, currency, rounding)}
                                <span class="report-drilldown" onclick="showAccountLedger(${conta.id}, null, '${asOfDate}')">üîç</span>
                            </td>
                        </tr>
                    `;
                }
            });
            
            const totalLiabilitiesEquity = totalLiabilities + totalEquity;
            
            html += `
                <tr class="subtotal-row">
                    <td><strong>Total do Passivo</strong></td>
                    <td><strong class="${getAmountClass(totalLiabilities)}">${formatCurrency(totalLiabilities, currency, rounding)}</strong></td>
                </tr>
                <tr class="subtotal-row">
                    <td><strong>Total do Patrim√¥nio L√≠quido</strong></td>
                    <td><strong class="${getAmountClass(totalEquity)}">${formatCurrency(totalEquity, currency, rounding)}</strong></td>
                </tr>
                <tr class="total-row">
                    <td><strong>TOTAL DO PASSIVO + PATRIM√îNIO L√çQUIDO</strong></td>
                    <td><strong class="${getAmountClass(totalLiabilitiesEquity)}">${formatCurrency(totalLiabilitiesEquity, currency, rounding)}</strong></td>
                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Verifica√ß√£o de equil√≠brio
            const isBalanced = Math.abs(totalAssets - totalLiabilitiesEquity) < 0.01;
            
            html += `
                <div style="margin-top: 20px;" class="${isBalanced ? 'success' : 'alert'}">
                    <strong>Verifica√ß√£o:</strong> ${isBalanced ? 
                        '‚úì Balan√ßo equilibrado (Ativo = Passivo + Patrim√¥nio L√≠quido)' : 
                        '‚úó Balan√ßo desequilibrado - verifique os lan√ßamentos'}
                </div>
            `;
            
            document.getElementById('reportResult').innerHTML = html;
            
            // Atualizar resumo
            updateBalanceSheetSummary(totalAssets, totalLiabilities, totalEquity, currency, rounding);
        }

        function generateIncomeStatement(startDate, endDate, compareWith, currency, rounding) {
            // Calcular movimentos do per√≠odo
            const periodMovements = calculateAccountMovements(new Date(startDate), new Date(endDate));
            
            // Gerar HTML do relat√≥rio
            let html = `
                <h3>üìà Demonstra√ß√£o de Resultados (DRE)</h3>
                <p class="small muted">Per√≠odo: ${formatDate(new Date(startDate))} a ${formatDate(new Date(endDate))}</p>
                
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Descri√ß√£o</th>
                            <th>Valor (${currency})</th>
                            <th>% da Receita</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Receitas
            let totalRevenue = 0;
            const revenueAccounts = accountMapping.income_statement.revenues;
            
            html += `<tr class="group-header"><td colspan="3">RECEITAS OPERACIONAIS</td></tr>`;
            
            revenueAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const movement = periodMovements[conta.id] || { debit: 0, credit: 0 };
                    // Para receitas, cr√©ditos aumentam e d√©bitos diminuem
                    const revenue = movement.credit - movement.debit;
                    totalRevenue += revenue;
                    
                    if (revenue !== 0) {
                        html += `
                            <tr>
                                <td>${conta.codigo} - ${conta.nome}</td>
                                <td class="${getAmountClass(revenue)}">
                                    ${formatCurrency(revenue, currency, rounding)}
                                    <span class="report-drilldown" onclick="showAccountLedger(${conta.id}, '${startDate}', '${endDate}')">üîç</span>
                                </td>
                                <td>${totalRevenue > 0 ? ((revenue / totalRevenue) * 100).toFixed(1) + '%' : '-'}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            html += `
                <tr class="subtotal-row">
                    <td><strong>Total de Receitas</strong></td>
                    <td><strong class="${getAmountClass(totalRevenue)}">${formatCurrency(totalRevenue, currency, rounding)}</strong></td>
                    <td><strong>100%</strong></td>
                </tr>
            `;
            
            // Despesas
            let totalExpenses = 0;
            const expenseAccounts = accountMapping.income_statement.expenses;
            
            html += `<tr class="group-header"><td colspan="3">DESPESAS OPERACIONAIS</td></tr>`;
            
            expenseAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const movement = periodMovements[conta.id] || { debit: 0, credit: 0 };
                    // Para despesas, d√©bitos aumentam e cr√©ditos diminuem
                    const expense = movement.debit - movement.credit;
                    totalExpenses += expense;
                    
                    if (expense !== 0) {
                        const percentage = totalRevenue > 0 ? (expense / totalRevenue) * 100 : 0;
                        
                        html += `
                            <tr>
                                <td>${conta.codigo} - ${conta.nome}</td>
                                <td class="${getAmountClass(-expense)}">
                                    ${formatCurrency(expense, currency, rounding)}
                                    <span class="report-drilldown" onclick="showAccountLedger(${conta.id}, '${startDate}', '${endDate}')">üîç</span>
                                </td>
                                <td>${totalRevenue > 0 ? percentage.toFixed(1) + '%' : '-'}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            html += `
                <tr class="subtotal-row">
                    <td><strong>Total de Despesas</strong></td>
                    <td><strong class="${getAmountClass(-totalExpenses)}">${formatCurrency(totalExpenses, currency, rounding)}</strong></td>
                    <td><strong>${totalRevenue > 0 ? ((totalExpenses / totalRevenue) * 100).toFixed(1) + '%' : '-'}</strong></td>
                </tr>
            `;
            
            // Resultado
            const netIncome = totalRevenue - totalExpenses;
            const netMargin = totalRevenue > 0 ? (netIncome / totalRevenue) * 100 : 0;
            
            html += `
                <tr class="total-row">
                    <td><strong>RESULTADO L√çQUIDO DO PER√çODO</strong></td>
                    <td><strong class="${getAmountClass(netIncome)}">${formatCurrency(netIncome, currency, rounding)}</strong></td>
                    <td><strong>${totalRevenue > 0 ? netMargin.toFixed(1) + '%' : '-'}</strong></td>
                </tr>
            `;
            
            html += `</tbody></table>`;
            
            // An√°lise de margens
            if (totalRevenue > 0) {
                const grossMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue) * 100 : 0;
                
                html += `
                    <div style="margin-top: 20px;">
                        <h4>An√°lise de Margens</h4>
                        <div class="results-row">
                            <div class="result-item">
                                <h3>Margem Bruta</h3>
                                <div class="kpi">${grossMargin.toFixed(1)}%</div>
                            </div>
                            <div class="result-item">
                                <h3>Margem L√≠quida</h3>
                                <div class="kpi">${netMargin.toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('reportResult').innerHTML = html;
            
            // Atualizar resumo
            updateIncomeStatementSummary(totalRevenue, totalExpenses, netIncome, currency, rounding);
        }

        function generateCashFlow(startDate, endDate, compareWith, currency, rounding) {
            // Calcular movimentos de contas de caixa
            const cashAccounts = accountMapping.cash_accounts;
            const periodMovements = calculateAccountMovements(new Date(startDate), new Date(endDate));
            
            // Calcular saldos iniciais e finais
            const initialBalances = calculateAccountBalances(null, new Date(startDate));
            const finalBalances = calculateAccountBalances(null, new Date(endDate));
            
            // Gerar HTML do relat√≥rio
            let html = `
                <h3>üí∞ Fluxo de Caixa (M√©todo Direto)</h3>
                <p class="small muted">Per√≠odo: ${formatDate(new Date(startDate))} a ${formatDate(new Date(endDate))}</p>
                
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Descri√ß√£o</th>
                            <th>Valor (${currency})</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Saldo inicial
            let initialCash = 0;
            cashAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    initialCash += initialBalances[conta.id] || 0;
                }
            });
            
            html += `
                <tr>
                    <td>Saldo Inicial de Caixa</td>
                    <td class="${getAmountClass(initialCash)}">${formatCurrency(initialCash, currency, rounding)}</td>
                </tr>
            `;
            
            // Atividades Operacionais
            html += `<tr class="group-header"><td colspan="2">ATIVIDADES OPERACIONAIS</td></tr>`;
            
            // Entradas operacionais (simplificado)
            let operatingInflows = 0;
            const revenueAccounts = accountMapping.income_statement.revenues;
            revenueAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const movement = periodMovements[conta.id] || { debit: 0, credit: 0 };
                    // Simplifica√ß√£o: considerar que toda receita √© entrada de caixa
                    operatingInflows += movement.credit;
                }
            });
            
            html += `
                <tr>
                    <td>Entradas Operacionais</td>
                    <td class="amount-positive">${formatCurrency(operatingInflows, currency, rounding)}</td>
                </tr>
            `;
            
            // Sa√≠das operacionais (simplificado)
            let operatingOutflows = 0;
            const expenseAccounts = accountMapping.income_statement.expenses;
            expenseAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    const movement = periodMovements[conta.id] || { debit: 0, credit: 0 };
                    // Simplifica√ß√£o: considerar que toda despesa √© sa√≠da de caixa
                    operatingOutflows += movement.debit;
                }
            });
            
            html += `
                <tr>
                    <td>Sa√≠das Operacionais</td>
                    <td class="amount-negative">${formatCurrency(operatingOutflows, currency, rounding)}</td>
                </tr>
            `;
            
            const netOperatingCash = operatingInflows - operatingOutflows;
            
            html += `
                <tr class="subtotal-row">
                    <td><strong>Fluxo L√≠quido das Atividades Operacionais</strong></td>
                    <td><strong class="${getAmountClass(netOperatingCash)}">${formatCurrency(netOperatingCash, currency, rounding)}</strong></td>
                </tr>
            `;
            
            // Atividades de Investimento (simplificado)
            html += `<tr class="group-header"><td colspan="2">ATIVIDADES DE INVESTIMENTO</td></tr>`;
            
            // Aquisi√ß√µes de ativos (simplificado)
            const investmentOutflows = 0; // Seria calculado com base em lan√ßamentos espec√≠ficos
            
            html += `
                <tr>
                    <td>Aquisi√ß√µes de Ativos</td>
                    <td class="amount-negative">${formatCurrency(investmentOutflows, currency, rounding)}</td>
                </tr>
                <tr class="subtotal-row">
                    <td><strong>Fluxo L√≠quido das Atividades de Investimento</strong></td>
                    <td><strong class="${getAmountClass(-investmentOutflows)}">${formatCurrency(-investmentOutflows, currency, rounding)}</strong></td>
                </tr>
            `;
            
            // Atividades de Financiamento (simplificado)
            html += `<tr class="group-header"><td colspan="2">ATIVIDADES DE FINANCIAMENTO</td></tr>`;
            
            // Aportes de investidores (simplificado)
            const financingInflows = 0; // Seria calculado com base em lan√ßamentos espec√≠ficos
            
            html += `
                <tr>
                    <td>Aportes de Capital</td>
                    <td class="amount-positive">${formatCurrency(financingInflows, currency, rounding)}</td>
                </tr>
                <tr class="subtotal-row">
                    <td><strong>Fluxo L√≠quido das Atividades de Financiamento</strong></td>
                    <td><strong class="${getAmountClass(financingInflows)}">${formatCurrency(financingInflows, currency, rounding)}</strong></td>
                </tr>
            `;
            
            // Varia√ß√£o total de caixa
            const netCashFlow = netOperatingCash - investmentOutflows + financingInflows;
            
            html += `
                <tr class="subtotal-row">
                    <td><strong>Varia√ß√£o L√≠quida de Caixa no Per√≠odo</strong></td>
                    <td><strong class="${getAmountClass(netCashFlow)}">${formatCurrency(netCashFlow, currency, rounding)}</strong></td>
                </tr>
            `;
            
            // Saldo final
            let finalCash = 0;
            cashAccounts.forEach(code => {
                const conta = planoContas.find(c => c.codigo === code);
                if (conta) {
                    finalCash += finalBalances[conta.id] || 0;
                }
            });
            
            html += `
                <tr>
                    <td>Saldo Final de Caixa</td>
                    <td class="${getAmountClass(finalCash)}">${formatCurrency(finalCash, currency, rounding)}</td>
                </tr>
            `;
            
            // Verifica√ß√£o
            const calculatedFinalCash = initialCash + netCashFlow;
            const isReconciled = Math.abs(finalCash - calculatedFinalCash) < 0.01;
            
            html += `
                <tr class="${isReconciled ? 'success' : 'alert'}" style="background-color: transparent;">
                    <td colspan="2">
                        <strong>Verifica√ß√£o:</strong> ${isReconciled ? 
                            '‚úì Reconcilia√ß√£o correta (Saldo Inicial + Varia√ß√£o = Saldo Final)' : 
                            '‚úó Erro na reconcilia√ß√£o - verifique os lan√ßamentos'}
                    </td>
                </tr>
            `;
            
            html += `</tbody></table>`;
            
            document.getElementById('reportResult').innerHTML = html;
            
            // Atualizar resumo
            updateCashFlowSummary(initialCash, finalCash, netCashFlow, currency, rounding);
        }

        // ========== FUN√á√ïES AUXILIARES DE RELAT√ìRIOS ==========
        function calculateAccountBalances(startDate, endDate) {
            const balances = {};
            
            // Inicializar todas as contas com saldo zero
            planoContas.forEach(conta => {
                balances[conta.id] = 0;
            });
            
            // Processar todos os lan√ßamentos at√© a data final
            lancamentos.forEach(lancamento => {
                const lancamentoDate = new Date(lancamento.data);
                
                // Verificar se o lan√ßamento est√° dentro do per√≠odo
                if ((!startDate || lancamentoDate >= startDate) && 
                    (!endDate || lancamentoDate <= endDate)) {
                    
                    const contaDebito = planoContas.find(c => c.id == lancamento.debito);
                    const contaCredito = planoContas.find(c => c.id == lancamento.credito);
                    
                    if (contaDebito) {
                        // Para d√©bito: aumenta Ativo/Despesa, diminui Passivo/Receita
                        if (contaDebito.tipo === 'Ativo' || contaDebito.tipo === 'Despesa') {
                            balances[contaDebito.id] += lancamento.valor;
                        } else {
                            balances[contaDebito.id] -= lancamento.valor;
                        }
                    }
                    
                    if (contaCredito) {
                        // Para cr√©dito: aumenta Passivo/Receita, diminui Ativo/Despesa
                        if (contaCredito.tipo === 'Passivo' || contaCredito.tipo === 'Receita' || contaCredito.tipo === 'Patrimonio') {
                            balances[contaCredito.id] += lancamento.valor;
                        } else {
                            balances[contaCredito.id] -= lancamento.valor;
                        }
                    }
                }
            });
            
            return balances;
        }

        function calculateAccountMovements(startDate, endDate) {
            const movements = {};
            
            // Inicializar todas as contas com movimentos zero
            planoContas.forEach(conta => {
                movements[conta.id] = { debit: 0, credit: 0 };
            });
            
            // Processar lan√ßamentos no per√≠odo
            lancamentos.forEach(lancamento => {
                const lancamentoDate = new Date(lancamento.data);
                
                // Verificar se o lan√ßamento est√° dentro do per√≠odo
                if (lancamentoDate >= startDate && lancamentoDate <= endDate) {
                    
                    const contaDebito = planoContas.find(c => c.id == lancamento.debito);
                    const contaCredito = planoContas.find(c => c.id == lancamento.credito);
                    
                    if (contaDebito) {
                        movements[contaDebito.id].debit += lancamento.valor;
                    }
                    
                    if (contaCredito) {
                        movements[contaCredito.id].credit += lancamento.valor;
                    }
                }
            });
            
            return movements;
        }

        function formatCurrency(amount, currency, rounding) {
            let value = amount;
            
            // Aplicar arredondamento
            if (rounding === 'thousands') {
                value = Math.round(value / 1000) * 1000;
            } else {
                value = Math.round(value * 100) / 100;
            }
            
            // Formatar com separadores
            const formatted = new Intl.NumberFormat('pt-MZ', {
                minimumFractionDigits: rounding === 'thousands' ? 0 : 2,
                maximumFractionDigits: rounding === 'thousands' ? 0 : 2
            }).format(value);
            
            // Adicionar s√≠mbolo de moeda
            const currencySymbols = {
                'MZN': 'MT',
                'USD': '$',
                'EUR': '‚Ç¨'
            };
            
            return `${currencySymbols[currency] || currency} ${formatted}`;
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-MZ');
        }

        function getAmountClass(amount) {
            if (amount > 0) return 'amount-positive';
            if (amount < 0) return 'amount-negative';
            return 'amount-zero';
        }

        function updateReportSummary(balances) {
            // Esta fun√ß√£o atualiza o resumo com base no √∫ltimo relat√≥rio gerado
            document.getElementById('reportSummary').style.display = 'grid';
        }

        function updateBalanceSheetSummary(totalAssets, totalLiabilities, totalEquity, currency, rounding) {
            document.getElementById('reportSummary').style.display = 'grid';
            document.getElementById('summaryTotalAssets').textContent = formatCurrency(totalAssets, currency, rounding);
            document.getElementById('summaryTotalLiabilities').textContent = formatCurrency(totalLiabilities, currency, rounding);
            document.getElementById('summaryTotalEquity').textContent = formatCurrency(totalEquity, currency, rounding);
            document.getElementById('summaryNetIncome').textContent = formatCurrency(totalEquity, currency, rounding);
        }

        function updateIncomeStatementSummary(totalRevenue, totalExpenses, netIncome, currency, rounding) {
            document.getElementById('reportSummary').style.display = 'grid';
            document.getElementById('summaryTotalAssets').textContent = formatCurrency(totalRevenue, currency, rounding);
            document.getElementById('summaryTotalLiabilities').textContent = formatCurrency(totalExpenses, currency, rounding);
            document.getElementById('summaryTotalEquity').textContent = formatCurrency(netIncome, currency, rounding);
            document.getElementById('summaryNetIncome').textContent = formatCurrency(netIncome, currency, rounding);
        }

        function updateCashFlowSummary(initialCash, finalCash, netCashFlow, currency, rounding) {
            document.getElementById('reportSummary').style.display = 'grid';
            document.getElementById('summaryTotalAssets').textContent = formatCurrency(initialCash, currency, rounding);
            document.getElementById('summaryTotalLiabilities').textContent = formatCurrency(finalCash, currency, rounding);
            document.getElementById('summaryTotalEquity').textContent = formatCurrency(netCashFlow, currency, rounding);
            document.getElementById('summaryNetIncome').textContent = formatCurrency(netCashFlow, currency, rounding);
        }

        function showAccountLedger(accountId, startDate, endDate) {
            const conta = planoContas.find(c => c.id === accountId);
            if (!conta) return;
            
            // Filtrar lan√ßamentos para esta conta
            const filteredLancamentos = lancamentos.filter(l => 
                l.debito == accountId || l.credito == accountId
            );
            
            // Aplicar filtro de data se fornecido
            let finalLancamentos = filteredLancamentos;
            if (startDate && endDate) {
                finalLancamentos = filteredLancamentos.filter(l => {
                    const lancamentoDate = new Date(l.data);
                    return lancamentoDate >= new Date(startDate) && lancamentoDate <= new Date(endDate);
                });
            } else if (endDate) {
                finalLancamentos = filteredLancamentos.filter(l => {
                    const lancamentoDate = new Date(l.data);
                    return lancamentoDate <= new Date(endDate);
                });
            }
            
            // Ordenar por data
            finalLancamentos.sort((a, b) => new Date(a.data) - new Date(b.data));
            
            // Gerar HTML do modal
            let html = `
                <h4>${conta.codigo} - ${conta.nome}</h4>
                <p class="small muted">${startDate && endDate ? 
                    `Per√≠odo: ${formatDate(new Date(startDate))} a ${formatDate(new Date(endDate))}` : 
                    endDate ? `At√©: ${formatDate(new Date(endDate))}` : 'Todos os lan√ßamentos'}</p>
                
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>D√©bito</th>
                            <th>Cr√©dito</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let runningBalance = 0;
            finalLancamentos.forEach(lancamento => {
                const isDebit = lancamento.debito == accountId;
                const amount = isDebit ? lancamento.valor : -lancamento.valor;
                runningBalance += amount;
                
                const otherAccountId = isDebit ? lancamento.credito : lancamento.debito;
                const otherAccount = planoContas.find(c => c.id == otherAccountId);
                const otherAccountName = otherAccount ? `${otherAccount.codigo} - ${otherAccount.nome}` : 'Conta n√£o encontrada';
                
                html += `
                    <tr>
                        <td>${lancamento.data}</td>
                        <td>${lancamento.descricao} (${otherAccountName})</td>
                        <td class="${isDebit ? 'amount-positive' : ''}">${isDebit ? formatCurrency(lancamento.valor, 'MZN', 'normal') : ''}</td>
                        <td class="${!isDebit ? 'amount-negative' : ''}">${!isDebit ? formatCurrency(lancamento.valor, 'MZN', 'normal') : ''}</td>
                        <td class="${getAmountClass(runningBalance)}">${formatCurrency(runningBalance, 'MZN', 'normal')}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
            document.getElementById('drilldownTitle').textContent = `Raz√£o Anal√≠tico - ${conta.codigo} - ${conta.nome}`;
            document.getElementById('drilldownContent').innerHTML = html;
            showModal('drilldownModal');
        }

        function clearReport() {
            document.getElementById('reportResult').innerHTML = `
                <p style="color: #6c757d; text-align: center; padding: 40px;">
                    Selecione um tipo de relat√≥rio e per√≠odo para gerar o relat√≥rio financeiro.
                </p>
            `;
            document.getElementById('exportButtons').style.display = 'none';
            document.getElementById('reportChart').style.display = 'none';
            document.getElementById('reportSummary').style.display = 'none';
        }

        function exportReport(format) {
            const reportTitle = document.querySelector('#reportResult h3')?.textContent || 'Relat√≥rio Financeiro';
            const reportDate = document.querySelector('#reportResult .small.muted')?.textContent || '';
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            if (format === 'csv') {
                // Implementar exporta√ß√£o CSV
                content = 'Relat√≥rio CSV\n';
                filename = `relatorio_${Date.now()}.csv`;
                mimeType = 'text/csv;charset=utf-8;';
            } else if (format === 'excel') {
                // Implementar exporta√ß√£o Excel
                content = 'Relat√≥rio Excel\n';
                filename = `relatorio_${Date.now()}.xls`;
                mimeType = 'application/vnd.ms-excel;charset=utf-8;';
            } else if (format === 'pdf') {
                // Implementar exporta√ß√£o PDF
                content = `
                    <html>
                        <head>
                            <title>${reportTitle} - Great Mola</title>
                            <style>
                                body { font-family: Arial, sans-serif; }
                                table { width: 100%; border-collapse: collapse; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                                .total-row { background-color: #e9ecef; font-weight: bold; }
                            </style>
                        </head>
                        <body>
                            <h1>${reportTitle} - Great Mola</h1>
                            <p>${reportDate}</p>
                            <p>Data de emiss√£o: ${new Date().toLocaleDateString()}</p>
                            ${document.getElementById('reportResult').innerHTML}
                        </body>
                    </html>
                `;
                filename = `relatorio_${Date.now()}.html`;
                mimeType = 'text/html;charset=utf-8;';
            }
            
            const dataBlob = new Blob([content], { type: mimeType });
            downloadFile(dataBlob, filename);
            
            // Registrar log de auditoria
            logAudit('EXPORT_REPORT', `Exportou relat√≥rio em formato ${format}`);
        }

        function printReport() {
            const reportContent = document.getElementById('reportResult').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Relat√≥rio Financeiro - Great Mola</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .total-row { background-color: #e9ecef; font-weight: bold; }
                            @media print {
                                body { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>Relat√≥rio Financeiro - Great Mola</h1>
                        <p>Data de emiss√£o: ${new Date().toLocaleDateString()}</p>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            // Registrar log de auditoria
            logAudit('PRINT_REPORT', 'Imprimiu relat√≥rio financeiro');
        }

        // ========== FUN√á√ïES EXISTENTES (resumidas) ==========
        function loadAllDataFromLocalStorage() {
            users = JSON.parse(localStorage.getItem('users') || '[]');
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            investors = JSON.parse(localStorage.getItem('investors') || '[]');
            agents = JSON.parse(localStorage.getItem('agents') || '[]');
            ssaAccounts = JSON.parse(localStorage.getItem('ssaAccounts') || '[]');
            stAccounts = JSON.parse(localStorage.getItem('stAccounts') || '[]');
            afAccounts = JSON.parse(localStorage.getItem('afAccounts') || '[]');
            ssaTransactions = JSON.parse(localStorage.getItem('ssaTransactions') || '[]');
            subchannels = JSON.parse(localStorage.getItem('subchannels') || '[]');
            approvals = JSON.parse(localStorage.getItem('approvals') || '[]');
            transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            planoContas = JSON.parse(localStorage.getItem('planoContas') || '[]');
            lancamentos = JSON.parse(localStorage.getItem('lancamentos') || '[]');
            auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            settings = JSON.parse(localStorage.getItem('settings') || '{}');
        }

        function initializeDefaultRoles() {
            // Implementa√ß√£o existente...
        }

        function initializeDefaultSettings() {
            // Implementa√ß√£o existente...
        }

        function loadDefaultPlanoContas() {
            // Implementa√ß√£o existente...
        }

        function downloadFile(blob, filename) {
            // Implementa√ß√£o existente...
        }

        function logAudit(action, details) {
            // Implementa√ß√£o existente...
        }

        function switchTab(tabName) {
            // Implementa√ß√£o existente...
        }

        function switchSubTab(subTabName) {
            // Implementa√ß√£o existente...
        }

        function login(event) {
            // Implementa√ß√£o existente...
        }

        function logout() {
            // Implementa√ß√£o existente...
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ========== INICIALIZA√á√ÉO DO SISTEMA ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar dados padr√£o
            initializeDefaultData();
            
            // Configurar event listeners
            document.getElementById('loginForm').addEventListener('submit', login);
            
            // Configurar datas padr√£o para relat√≥rios
            setupReportDates();
            
            console.log('Sistema Great Mola inicializado com sucesso!');
        });
    </script>
</body>
</html>
